<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>THE REFRAME // SYSTEM_ETHEL</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;800&family=Inter:wght@300;600&display=swap">
    <style>
        :root {
            --term-green: #00ff41;
            --term-bg: #0d0d0d;
            --wellness-blue: #a0d8ef;
            --alert-red: #ff3333;
        }

        body {
            background-color: var(--term-bg);
            color: var(--term-green);
            font-family: 'JetBrains Mono', monospace;
            overflow: hidden;
            height: 100vh;
            user-select: none;
        }

        /* Page Background Image */
        .page-bg {
            position: fixed;
            inset: 0;
            z-index: 0;
            background: url('https://pub-111e813bd5634cd8a9ecdd3d5c2a0916.r2.dev/images_ethelGameV1/IMG_REFRAME_BKG.jpg') center/cover no-repeat;
        }

        .page-bg-overlay {
            position: fixed;
            inset: 0;
            z-index: 1;
            background: rgba(0, 0, 0, 0.72);
        }

        /* CRT Effects */
        .scanline {
            width: 100%;
            height: 100px;
            z-index: 10;
            background: linear-gradient(0deg, rgba(0, 0, 0, 0) 0%, rgba(0, 255, 65, 0.04) 50%, rgba(0, 0, 0, 0) 100%);
            opacity: 0.1;
            position: absolute;
            bottom: 100%;
            animation: scanline 10s linear infinite;
            pointer-events: none;
        }

        .crt-overlay {
            background: radial-gradient(circle, rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 100%);
            background-size: 4px 4px;
            pointer-events: none;
            position: fixed;
            inset: 0;
            z-index: 50;
        }

        @keyframes scanline {
            0% {
                bottom: 100%;
            }

            100% {
                bottom: -100%;
            }
        }

        /* Blur Stages (The Gaslight Mechanic) */
        .blur-0 {
            filter: blur(0px);
        }

        .blur-1 {
            filter: blur(0.8px);
            opacity: 0.95;
        }

        .blur-2 {
            filter: blur(1.5px);
            opacity: 0.9;
        }

        .blur-3 {
            filter: blur(2.5px);
            opacity: 0.8;
        }

        .blur-4 {
            filter: blur(4px);
            opacity: 0.6;
        }

        /* Card Transitions */
        .card-container {
            perspective: 1000px;
            width: 100%;
            max-width: 700px;
            height: 400px;
            position: relative;
        }

        .card {
            position: absolute;
            width: 100%;
            height: 100%;
            border: 1px solid var(--term-green);
            box-shadow: 0 0 15px rgba(0, 255, 65, 0.1);
            transition: transform 0.4s cubic-bezier(0.25, 0.8, 0.25, 1), opacity 0.3s;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 2rem;
            overflow: hidden;
            background: #111;
        }

        .card-bg-image {
            position: absolute;
            inset: 0;
            background-size: cover;
            background-position: center;
            opacity: 0.85;
            z-index: 0;
        }

        .card-bg-darken {
            position: absolute;
            inset: 0;
            background: linear-gradient(180deg, rgba(0, 0, 0, 0.2) 0%, rgba(17, 17, 17, 0.55) 100%);
            z-index: 1;
        }

        .card-content {
            position: relative;
            z-index: 2;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            height: 100%;
        }

        .card.exit-left {
            transform: translateX(-120%) rotate(-10deg);
            opacity: 0;
        }

        .card.exit-right {
            transform: translateX(120%) rotate(10deg);
            opacity: 0;
        }

        /* HUD Bars */
        .bar-container {
            background: #222;
            height: 6px;
            width: 100%;
            margin-top: 5px;
        }

        .bar-fill {
            height: 100%;
            transition: width 0.3s ease;
        }

        /* Glitch Text */
        .glitch-text {
            animation: glitch 2s infinite;
        }

        @keyframes glitch {
            0% {
                text-shadow: 2px 0 red;
            }

            90% {
                text-shadow: 2px 0 red;
            }

            91% {
                text-shadow: -2px 0 blue;
            }

            100% {
                text-shadow: -2px 0 blue;
            }
        }

        /* Intro Overlay */
        #intro-overlay {
            position: fixed;
            inset: 0;
            z-index: 200;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: url('https://pub-111e813bd5634cd8a9ecdd3d5c2a0916.r2.dev/images_ethelGameV1/IMG_REFRAME_BKG.jpg') center/cover no-repeat;
            text-align: center;
        }

        #intro-overlay::after {
            content: '';
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, 0.75);
            z-index: 0;
        }

        #intro-overlay>* {
            position: relative;
            z-index: 1;
        }

        #intro-btn {
            padding: 1rem 3rem;
            border: 2px solid var(--term-green);
            color: var(--term-green);
            background: rgba(0, 0, 0, 0.7);
            font-family: 'JetBrains Mono', monospace;
            font-weight: bold;
            font-size: 1.1rem;
            letter-spacing: 0.2em;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.3s;
        }

        #intro-btn:hover {
            background: var(--term-green);
            color: black;
        }

        #intro-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        #intro-status {
            margin-top: 1.5rem;
            font-size: 0.75rem;
            color: var(--term-green);
            opacity: 0.7;
            letter-spacing: 0.15em;
            text-transform: uppercase;
            min-height: 1.2em;
        }

        /* Audio Loading Indicator */
        .loading-pulse {
            animation: loadPulse 1.5s ease-in-out infinite;
        }

        @keyframes loadPulse {

            0%,
            100% {
                opacity: 0.3;
            }

            50% {
                opacity: 1;
            }
        }
    </style>
</head>

<body class="flex flex-col items-center justify-center relative">

    <!-- Background Image Layer -->
    <div class="page-bg"></div>
    <div class="page-bg-overlay"></div>

    <!-- Intro Overlay -->
    <div id="intro-overlay">
        <h1 class="text-4xl md:text-6xl font-black tracking-tighter mb-2 glitch-text" style="color: var(--term-green);">
            THE REFRAME</h1>
        <p class="text-sm md:text-base text-white/60 font-mono mb-10 tracking-widest uppercase">System_Ethel // Session
            Init</p>
        <button id="intro-btn" onclick="beginSession()">Begin Session</button>
        <p id="intro-status"></p>
    </div>

    <div class="scanline"></div>
    <div class="crt-overlay"></div>

    <div
        class="absolute top-0 w-full p-6 flex justify-between z-40 bg-black/80 backdrop-blur-sm border-b border-white/10">
        <div class="w-1/3">
            <div class="flex justify-between text-xs font-bold uppercase tracking-widest mb-1">
                <span class="text-[--term-green]">Forensic Integrity</span>
                <span id="evidence-val">100%</span>
            </div>
            <div class="bar-container">
                <div id="evidence-bar" class="bar-fill bg-[--term-green]" style="width: 100%;"></div>
            </div>
        </div>

        <div class="text-center">
            <h1 class="text-xl font-bold tracking-tighter glitch-text">THE REFRAME</h1>
            <p id="timer" class="text-sm font-mono text-white/50">02:00</p>
        </div>

        <div class="w-1/3 text-right">
            <div class="flex justify-between text-xs font-bold uppercase tracking-widest mb-1">
                <span class="text-[--wellness-blue]">Therapeutic Comfort</span>
                <span id="comfort-val">0%</span>
            </div>
            <div class="bar-container">
                <div id="comfort-bar" class="bar-fill bg-[--wellness-blue]" style="width: 0%;"></div>
            </div>
        </div>
    </div>

    <main class="relative w-full h-full flex items-center justify-center p-4" style="z-index: 5;">
        <div id="card-wrapper" class="card-container">
        </div>
    </main>

    <div class="fixed bottom-10 w-full max-w-2xl flex gap-6 px-6 z-40">
        <button onclick="handleSwipe('left')"
            class="flex-1 p-6 border border-[--wellness-blue] text-[--wellness-blue] bg-black/80 hover:bg-[--wellness-blue] hover:text-black transition-all uppercase font-bold tracking-widest text-sm">
            <span class="block text-xs opacity-50 mb-1">Accept Reframe</span>
            SOFTEN REALITY
        </button>
        <button onclick="handleSwipe('right')"
            class="flex-1 p-6 border border-[--term-green] text-[--term-green] bg-black/80 hover:bg-[--term-green] hover:text-black transition-all uppercase font-bold tracking-widest text-sm">
            <span class="block text-xs opacity-50 mb-1">Preserve Data</span>
            INVESTIGATE
        </button>
    </div>

    <div id="end-screen"
        class="hidden fixed inset-0 z-[100] bg-black flex-col items-center justify-center p-8 text-center border-4 border-[--term-green]">
        <h1 id="end-title" class="text-5xl font-black mb-4 tracking-tighter uppercase text-[--term-green]">SESSION
            CLOSED</h1>
        <p id="end-reason" class="text-lg mb-8 font-mono text-white/80 max-w-md leading-relaxed"></p>

        <div class="grid grid-cols-2 gap-8 w-full max-w-lg mb-8 border-t border-b border-white/20 py-8">
            <div>
                <div class="text-[10px] uppercase text-white/40 mb-2">Evidence Retained</div>
                <div id="end-evidence" class="text-4xl font-bold text-[--term-green]">0%</div>
            </div>
            <div>
                <div class="text-[10px] uppercase text-white/40 mb-2">Comfort Level</div>
                <div id="end-comfort" class="text-4xl font-bold text-[--wellness-blue]">0%</div>
            </div>
        </div>

        <button onclick="location.reload()"
            class="px-8 py-3 bg-[--term-green] text-black font-bold uppercase tracking-widest hover:bg-white transition-all">
            Restart System
        </button>
    </div>

    <script>
        // =============================================
        // ASSET BASE URLS
        // =============================================
        const AUDIO_BASE = "https://pub-111e813bd5634cd8a9ecdd3d5c2a0916.r2.dev/audio_ethelGameV1/";
        const IMAGE_BASE = "https://pub-111e813bd5634cd8a9ecdd3d5c2a0916.r2.dev/images_ethelGameV1/";

        // =============================================
        // AUDIO ENGINE — Preload, Play, Stop
        // =============================================
        const AudioEngine = {
            cache: {},
            current: null,

            // Register and preload all audio files
            preload(manifest) {
                const promises = [];
                for (const [key, filename] of Object.entries(manifest)) {
                    const audio = new Audio();
                    audio.preload = 'auto';
                    audio.src = AUDIO_BASE + filename;
                    this.cache[key] = audio;
                    promises.push(new Promise(resolve => {
                        audio.addEventListener('canplaythrough', resolve, { once: true });
                        audio.addEventListener('error', () => {
                            console.warn(`[AudioEngine] Failed to load: ${key} → ${filename}`);
                            resolve(); // don't block on errors
                        });
                        // Force load
                        audio.load();
                    }));
                }
                return Promise.all(promises);
            },

            play(key) {
                this.stop();
                const audio = this.cache[key];
                if (!audio) {
                    console.warn(`[AudioEngine] No audio for key: ${key}`);
                    return Promise.resolve();
                }
                audio.currentTime = 0;
                this.current = audio;
                return audio.play().catch(e => console.warn(`[AudioEngine] Play blocked: ${key}`, e));
            },

            playAndWait(key) {
                return new Promise(resolve => {
                    this.stop();
                    const audio = this.cache[key];
                    if (!audio) { resolve(); return; }
                    audio.currentTime = 0;
                    this.current = audio;
                    audio.addEventListener('ended', resolve, { once: true });
                    audio.play().catch(() => resolve());
                });
            },

            stop() {
                if (this.current) {
                    this.current.pause();
                    this.current.currentTime = 0;
                    this.current = null;
                }
            }
        };

        // =============================================
        // SFX ENGINE — Web Audio API synthesized sounds
        // =============================================
        const SFX = {
            ctx: null,

            init() {
                this.ctx = new (window.AudioContext || window.webkitAudioContext)();
            },

            // Glitch/static burst on Reframe choice
            glitchBlur() {
                if (!this.ctx) this.init();
                const ctx = this.ctx;
                const duration = 0.15;
                const bufferSize = ctx.sampleRate * duration;
                const buffer = ctx.createBuffer(1, bufferSize, ctx.sampleRate);
                const data = buffer.getChannelData(0);
                for (let i = 0; i < bufferSize; i++) {
                    data[i] = (Math.random() * 2 - 1) * Math.pow(1 - i / bufferSize, 2);
                }
                const source = ctx.createBufferSource();
                source.buffer = buffer;
                const filter = ctx.createBiquadFilter();
                filter.type = 'bandpass';
                filter.frequency.value = 3000;
                filter.Q.value = 5;
                const gain = ctx.createGain();
                gain.gain.setValueAtTime(0.35, ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + duration);
                source.connect(filter).connect(gain).connect(ctx.destination);
                source.start();
            },

            // Heavy mechanical thud on Investigate choice
            evidenceLock() {
                if (!this.ctx) this.init();
                const ctx = this.ctx;
                const osc = ctx.createOscillator();
                osc.type = 'sine';
                osc.frequency.setValueAtTime(80, ctx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(20, ctx.currentTime + 0.25);
                const gain = ctx.createGain();
                gain.gain.setValueAtTime(0.6, ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.3);
                osc.connect(gain).connect(ctx.destination);
                osc.start();
                osc.stop(ctx.currentTime + 0.3);
            }
        };

        // =============================================
        // AUDIO MANIFEST — all files to preload
        // =============================================
        const AUDIO_MANIFEST = {
            // Intro
            THERAPIST_INTRO: 'THERAPIST_INTRO.mp3',
            ETHEL_INTRO: 'ETHEL_INTRO.mp3',

            // Per-card: Therapist
            THERAPIST_C1: 'THERAPIST_C1.mp3',
            THERAPIST_C2: 'THERAPIST_C2.mp3',
            THERAPIST_C3: 'THERAPIST_C3.mp3',
            THERAPIST_C4: 'THERAPIST_C4.mp3',
            THERAPIST_C5: 'THERAPIST_C5.mp3',
            THERAPIST_C6: 'THERAPIST_C6.mp3',
            THERAPIST_C7: 'THERAPIST_C7.mp3',
            THERAPIST_C8: 'THERAPIST_C8.mp3',
            THERAPIST_C9: 'THERAPIST_C9.mp3',
            THERAPIST_C10: 'THERAPIST_C10.mp3',

            // Per-card: Ethel
            ETHEL_C1: 'ETHEL_C1.mp3',
            ETHEL_C2: 'ETHEL_C2.mp3',
            ETHEL_C3: 'ETHEL_C3.mp3',
            ETHEL_C4: 'ETHEL_C4.mp3',
            ETHEL_C5: 'ETHEL_C5.mp3',

            // End game
            ETHEL_WIN: 'ETHEL_WIN.mp3',
            ETHEL_LOSE: 'ETHEL_LOSE.mp3'
        };

        // =============================================
        // DATA: ETHEL'S TIMELINE (with audio + images)
        // =============================================
        const CARDS = [
            {
                id: 1,
                source: "INCIDENT LOG: MORNING",
                text: "There is a red stick wedged vertically in my bike wheel. It's dead straight. Zero bounce. It was placed there.",
                a: "Maybe it was just a kid playing? Let's not catastrophize.",
                b: "It's a test of reaction time. Who is watching from the balcony?",
                image: null,
                therapistAudio: 'THERAPIST_C1',
                ethelAudio: 'ETHEL_C1'
            },
            {
                id: 2,
                source: "SURVEILLANCE: 409 VICTORIA ST",
                text: "The man with the Clipboard matches my pace. He doesn't look at me, but he stops when I stop.",
                a: "You're feeling watched because of your history. It's a coincidence.",
                b: "He's not a threat, he's a reflection. Log his pattern. Find who he reports to.",
                image: 'IMG_CARD_CLIPBOARD.jpg',
                therapistAudio: 'THERAPIST_C2',
                ethelAudio: 'ETHEL_C2'
            },
            {
                id: 3,
                source: "MEMORY: THE CRASH (2019)",
                text: "Gran was a chemist. Precise. She didn't 'drift' off a road she drove for forty years.",
                a: "Grief looks for reasons. Accidents happen to everyone.",
                b: "The police report had missing pages. The timeline doesn't fit the physics.",
                image: null,
                therapistAudio: 'THERAPIST_C3',
                ethelAudio: 'ETHEL_C3'
            },
            {
                id: 4,
                source: "PROFILE: DOMINIC RYKER",
                text: "He didn't 'take me in' after the crash. He acquired me. The house was a cage with glass walls.",
                a: "He was your father trying to connect in a difficult time.",
                b: "He needed the asset. He used silence as a weapon. Document the coercion.",
                image: 'IMG_CARD_DOMINIC.jpg',
                therapistAudio: 'THERAPIST_C4',
                ethelAudio: null // No Ethel clip for this card
            },
            {
                id: 5,
                source: "DATA: GITHUB LOGS",
                text: "Kinley's name appeared in the commit history for three minutes. Then it was retracted.",
                a: "Glitches happen. Don't let obsession ruin your new job.",
                b: "Screenshot the hash. That wasn't a glitch, it was a signal. He has access.",
                image: 'IMG_CARD_CODE.jpg',
                therapistAudio: 'THERAPIST_C5',
                ethelAudio: 'ETHEL_C4' // "A name doesn't type itself. The commit existed..."
            },
            {
                id: 6,
                source: "INTERACTION: DETECTIVE STICKY",
                text: "He told me: 'You will be reckless. You will be a problem.' He's trying to stop me.",
                a: "He's trying to help you stay safe. You need allies.",
                b: "He sees the rattle. He knows I'm right, but he knows the system is rigged.",
                image: 'IMG_CARD_DETECTIVE.jpg',
                therapistAudio: 'THERAPIST_C6',
                ethelAudio: 'ETHEL_C5' // "He wasn't offering help. He was identifying a leak..."
            },
            {
                id: 7,
                source: "SYSTEM ALERT",
                text: "I can feel the 'Harm's Ghost'. I know the damage is coming before it hits. I have to move.",
                a: "This is anxiety talking. Work on tolerance for uncertainty.",
                b: "Trust the pattern recognition. If inputs match the crash model, initiate exit.",
                image: 'IMG_CARD_HARM.jpg',
                therapistAudio: 'THERAPIST_C7',
                ethelAudio: null // No Ethel clip for this card
            }
        ];

        // =============================================
        // GAME STATE
        // =============================================
        let state = {
            index: 0,
            evidence: 100,
            comfort: 0,
            blurLevel: 0,
            timerInterval: null,
            gameStarted: false
        };

        const wrapper = document.getElementById('card-wrapper');

        // =============================================
        // INTRO SEQUENCE
        // =============================================
        async function beginSession() {
            const btn = document.getElementById('intro-btn');
            const status = document.getElementById('intro-status');

            btn.disabled = true;
            status.textContent = 'LOADING AUDIO ASSETS...';
            status.classList.add('loading-pulse');

            // Preload all audio
            await AudioEngine.preload(AUDIO_MANIFEST);

            status.textContent = 'THERAPIST CONNECTING...';

            // Play therapist intro, wait for it to finish
            await AudioEngine.playAndWait('THERAPIST_INTRO');

            status.textContent = 'SUBJECT RESPONDING...';

            // Play Ethel intro, wait for it to finish
            await AudioEngine.playAndWait('ETHEL_INTRO');

            // Dismiss intro overlay, start the game
            document.getElementById('intro-overlay').style.display = 'none';
            state.gameStarted = true;
            init();
        }

        // =============================================
        // GAME INIT
        // =============================================
        function init() {
            renderCard(state.index);
            startTimer();
        }

        // =============================================
        // CARD RENDERING (with images)
        // =============================================
        function renderCard(index) {
            wrapper.innerHTML = '';
            if (index >= CARDS.length) {
                endGame("complete");
                return;
            }

            const data = CARDS[index];
            const card = document.createElement('div');
            card.className = `card blur-${state.blurLevel}`;
            card.id = `card-${index}`;

            // Build image layers if card has an image
            let imageLayers = '';
            if (data.image) {
                imageLayers = `
                    <div class="card-bg-image" style="background-image: url('${IMAGE_BASE}${data.image}');"></div>
                    <div class="card-bg-darken"></div>
                `;
            }

            card.innerHTML = `
                ${imageLayers}
                <div class="card-content">
                    <div class="flex justify-between border-b border-white/20 pb-4 mb-4">
                        <span class="text-xs uppercase text-white/40 font-mono tracking-widest">SOURCE: ${data.source}</span>
                        <span class="text-xs uppercase text-white/40 font-mono">STATUS: ACTIVE</span>
                    </div>
                    <div class="flex-grow flex items-center justify-center">
                        <p class="text-xl md:text-2xl font-bold leading-tight text-center text-white">${data.text}</p>
                    </div>
                    <div class="grid grid-cols-2 gap-4 mt-6 pt-6 border-t border-white/20">
                        <div class="text-left opacity-70">
                            <span class="text-[10px] uppercase text-[--wellness-blue] block mb-2 font-bold">Reframed (Left)</span>
                            <p class="text-xs font-serif italic text-white/80">"${data.a}"</p>
                        </div>
                        <div class="text-right opacity-70">
                            <span class="text-[10px] uppercase text-[--term-green] block mb-2 font-bold">Investigated (Right)</span>
                            <p class="text-xs font-mono text-[--term-green]">"${data.b}"</p>
                        </div>
                    </div>
                </div>
            `;
            wrapper.appendChild(card);
        }

        // =============================================
        // SWIPE HANDLER (with audio + SFX)
        // =============================================
        let isProcessing = false; // prevent double-clicks
        let hasInvestigated = false; // track if current card was investigated

        function handleSwipe(dir) {
            if (!state.gameStarted || isProcessing) return;

            const card = document.getElementById(`card-${state.index}`);
            if (!card) return;

            const data = CARDS[state.index];

            if (dir === 'left') {
                // REFRAME (Trap): Lose integrity, gain comfort, increase blur
                // This always advances to the next card
                isProcessing = true;

                // Stop any currently playing audio immediately
                AudioEngine.stop();

                // Visual Exit
                card.classList.add('exit-left');

                state.evidence -= 20;
                state.comfort += 20;
                state.blurLevel = Math.min(4, state.blurLevel + 1);

                // Play glitch SFX first (150ms burst), then start therapist voice
                // after the SFX clears — prevents audio contention/stuttering
                SFX.glitchBlur();
                setTimeout(() => {
                    AudioEngine.play(data.therapistAudio);
                }, 200);

                // Cap values
                state.evidence = Math.max(0, Math.min(100, state.evidence));
                state.comfort = Math.max(0, Math.min(100, state.comfort));
                updateHUD();

                if (state.evidence <= 0) {
                    setTimeout(() => { isProcessing = false; endGame("gaslight"); }, 500);
                } else {
                    state.index++;
                    hasInvestigated = false;
                    setTimeout(() => { isProcessing = false; renderCard(state.index); }, 500);
                }

            } else {
                // INVESTIGATE (Truth): Play Ethel's audio and STAY on the current card
                // This lets the player absorb the evidence before moving on

                // Apply stat changes only on first investigate per card
                if (!hasInvestigated) {
                    state.evidence += 10;
                    state.comfort -= 10;
                    state.blurLevel = Math.max(0, state.blurLevel - 1);
                    hasInvestigated = true;

                    // Cap values
                    state.evidence = Math.max(0, Math.min(100, state.evidence));
                    state.comfort = Math.max(0, Math.min(100, state.comfort));
                    updateHUD();
                }

                // Play Ethel audio + evidence lock SFX (replays if clicked again)
                AudioEngine.play(data.ethelAudio);
                SFX.evidenceLock();

                // Don't advance — player stays on this card to investigate
                // They must choose "Soften Reality" (Reframe) to move on
            }
        }

        // =============================================
        // HUD UPDATE
        // =============================================
        function updateHUD() {
            document.getElementById('evidence-bar').style.width = `${state.evidence}%`;
            document.getElementById('evidence-val').innerText = `${state.evidence}%`;
            document.getElementById('comfort-bar').style.width = `${state.comfort}%`;
            document.getElementById('comfort-val').innerText = `${state.comfort}%`;

            const evBar = document.getElementById('evidence-bar');
            if (state.evidence < 30) evBar.style.backgroundColor = "var(--alert-red)";
            else evBar.style.backgroundColor = "var(--term-green)";
        }

        // =============================================
        // TIMER
        // =============================================
        function startTimer() {
            let time = 120;
            const timerEl = document.getElementById('timer');
            state.timerInterval = setInterval(() => {
                time--;
                const m = Math.floor(time / 60);
                const s = time % 60;
                timerEl.innerText = `0${m}:${s < 10 ? '0' + s : s}`;

                if (time <= 0 || state.index >= CARDS.length || state.evidence <= 0) {
                    clearInterval(state.timerInterval);
                    if (time <= 0) endGame("time");
                }
            }, 1000);
        }

        // =============================================
        // END GAME (with audio)
        // =============================================
        function endGame(reason) {
            // Stop any currently playing audio
            AudioEngine.stop();
            if (state.timerInterval) clearInterval(state.timerInterval);

            const screen = document.getElementById('end-screen');
            const title = document.getElementById('end-title');
            const desc = document.getElementById('end-reason');

            screen.classList.remove('hidden');
            screen.classList.add('flex');

            document.getElementById('end-evidence').innerText = `${state.evidence}%`;
            document.getElementById('end-comfort').innerText = `${state.comfort}%`;

            if (reason === "gaslight") {
                title.innerText = "SUBJECT COMPLIANT";
                title.style.color = "var(--wellness-blue)";
                desc.innerText = "You have successfully reframed reality until it disappeared. You feel calm, safe, and have absolutely no proof of what happened to you.";
                AudioEngine.play('ETHEL_LOSE');
            } else if (reason === "time") {
                title.innerText = "TIMELINE EXPIRED";
                title.style.color = "var(--alert-red)";
                desc.innerText = "You spent too long deliberating. The evidence has been overwritten by the system.";
                AudioEngine.play('THERAPIST_C9');
            } else {
                // Completed
                if (state.evidence > 50) {
                    title.innerText = "WITNESS CONFIRMED";
                    title.style.color = "var(--term-green)";
                    desc.innerText = "You are labeled 'difficult,' 'hostile,' and 'paranoid.' But you have the files. You know the truth about Kinley, Dominic, and the Crash.";
                    AudioEngine.play('ETHEL_WIN');
                } else {
                    title.innerText = "COMPROMISED";
                    title.style.color = "white";
                    desc.innerText = "You survived the session, but you traded too much truth for comfort. The timeline is blurry.";
                    AudioEngine.play('ETHEL_LOSE');
                }
            }
        }
    </script>
</body>

</html>
