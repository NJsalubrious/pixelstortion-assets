<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>SUPREME BEAT BOX // 3D EXPERIENCE</title>
    <style>
        :root {
            --neon-green: #00ff41;
            --neon-amber: #ff9500;
            --neon-cyan: #00ffff;
            --neon-red: #ff4444;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            overflow: hidden;
            background: #000;
            font-family: 'Courier New', monospace;
            color: var(--neon-green);
            cursor: crosshair;
        }

        /* MINIMAL HUD */
        #hud-top {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(to bottom, rgba(0, 0, 0, 0.95), transparent);
            pointer-events: none;
            z-index: 100;
        }

        .title {
            font-size: 16px;
            letter-spacing: 4px;
            text-shadow: 0 0 15px var(--neon-green);
        }

        .blink {
            animation: blinker 1s infinite;
        }

        @keyframes blinker {
            50% {
                opacity: 0;
            }
        }

        /* NOW PLAYING */
        #now-playing {
            position: fixed;
            bottom: 90px;
            left: 50%;
            transform: translateX(-50%);
            text-align: center;
            z-index: 100;
            pointer-events: none;
        }

        .np-label {
            font-size: 8px;
            color: var(--neon-green);
            letter-spacing: 2px;
            opacity: 0.6;
        }

        .np-title {
            font-size: 14px;
            color: #fff;
            text-shadow: 0 0 20px var(--neon-green);
            margin-top: 3px;
        }

        .np-artist {
            font-size: 10px;
            color: var(--neon-cyan);
            margin-top: 2px;
        }

        /* FLOATING CONTROLS */
        #control-bar {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            align-items: center;
            gap: 12px;
            background: rgba(0, 10, 0, 0.9);
            border: 1px solid rgba(0, 255, 65, 0.4);
            padding: 10px 20px;
            border-radius: 40px;
            backdrop-filter: blur(10px);
            z-index: 100;
        }

        .ctrl-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 1px solid #333;
            background: transparent;
            color: #888;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .ctrl-btn:hover {
            border-color: var(--neon-green);
            color: var(--neon-green);
            box-shadow: 0 0 15px rgba(0, 255, 65, 0.5);
        }

        .ctrl-btn.play-btn {
            width: 50px;
            height: 50px;
            border-width: 2px;
            font-size: 18px;
        }

        .ctrl-btn.active {
            background: var(--neon-green);
            color: #000;
        }

        .volume-slider {
            width: 50px;
            height: 3px;
            -webkit-appearance: none;
            background: #333;
            cursor: pointer;
        }

        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 10px;
            height: 10px;
            background: var(--neon-green);
            border-radius: 50%;
        }

        /* START SCREEN */
        #start-screen {
            position: fixed;
            inset: 0;
            background: #000;
            z-index: 500;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .start-title {
            font-size: 28px;
            letter-spacing: 6px;
            color: var(--neon-green);
            text-shadow: 0 0 30px var(--neon-green);
        }

        .start-sub {
            color: #444;
            font-size: 10px;
            letter-spacing: 3px;
            margin: 10px 0 25px;
        }

        .start-btn {
            border: 1px solid var(--neon-green);
            padding: 10px 30px;
            font-size: 10px;
            color: var(--neon-green);
        }

        /* Node Labels */
        .node-label {
            position: absolute;
            font-size: 9px;
            background: rgba(0, 0, 0, 0.9);
            padding: 3px 8px;
            border: 1px solid var(--neon-green);
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
            white-space: nowrap;
        }

        .node-label.visible {
            opacity: 1;
        }

        .node-label.active {
            border-color: #fff;
            background: rgba(0, 255, 65, 0.2);
            box-shadow: 0 0 10px var(--neon-green);
        }
    </style>
    <script type="importmap">
    {
        "imports": {
            "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
            "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
        }
    }
    </script>
</head>

<body>

    <!-- HUD -->
    <div id="hud-top">
        <div class="title">SUPREME BEAT BOX <span class="blink">_</span></div>
        <div style="font-size: 9px; color: #555;">CLICK NODES TO PLAY</div>
    </div>

    <div id="now-playing">
        <div class="np-label">NOW PLAYING</div>
        <div class="np-title" id="np-title">SELECT A NODE</div>
        <div class="np-artist" id="np-artist">‚Äî</div>
    </div>

    <div id="control-bar">
        <button class="ctrl-btn" id="prev-btn">‚èÆ</button>
        <button class="ctrl-btn play-btn" id="play-btn">‚ñ∂</button>
        <button class="ctrl-btn" id="next-btn">‚è≠</button>
        <button class="ctrl-btn" id="shuffle-btn">üîÄ</button>
        <input type="range" class="volume-slider" id="volume" min="0" max="100" value="80">
    </div>

    <div id="start-screen">
        <div class="start-title">SUPREME BEAT BOX</div>
        <div class="start-sub">3D AUDIO EXPERIENCE</div>
        <div class="start-btn blink">[ CLICK TO ENTER ]</div>
    </div>

    <!-- YouTube Player (MUST be visible for API to work, just tiny) -->
    <div id="youtube-player"
        style="position:fixed;bottom:0;right:0;width:1px;height:1px;opacity:0;pointer-events:none;"></div>

    <!-- YouTube API - MUST load before module -->
    <script src="https://www.youtube.com/iframe_api"></script>

    <!-- YouTube Ready Handler - MUST be in global scope BEFORE module -->
    <script>
        // Global state for YouTube
        var ytPlayer = null;
        var ytReady = false;
        var currentVideoId = null;
        var onYTReadyCallbacks = [];

        function onYouTubeIframeAPIReady() {
            console.log('[YT] API Ready, creating player...');
            ytPlayer = new YT.Player('youtube-player', {
                height: '1',
                width: '1',
                playerVars: {
                    autoplay: 0,
                    controls: 0,
                    rel: 0,
                    modestbranding: 1,
                    iv_load_policy: 3,
                    fs: 0,
                    disablekb: 1
                },
                events: {
                    onReady: function () {
                        console.log('[YT] Player Ready!');
                        ytReady = true;
                        // Execute any waiting callbacks
                        onYTReadyCallbacks.forEach(function (cb) { cb(); });
                        onYTReadyCallbacks = [];
                    },
                    onStateChange: function (e) {
                        if (e.data === YT.PlayerState.ENDED && window.onTrackEnded) {
                            window.onTrackEnded();
                        }
                        if (e.data === YT.PlayerState.PLAYING && window.onPlayStateChanged) {
                            window.onPlayStateChanged(true);
                        }
                        if (e.data === YT.PlayerState.PAUSED && window.onPlayStateChanged) {
                            window.onPlayStateChanged(false);
                        }
                    },
                    onError: function (e) {
                        console.error('[YT] Error:', e.data);
                        if (window.onTrackEnded) window.onTrackEnded();
                    }
                }
            });
        }

        // Helper to load a video with start/end times
        function loadYouTubeVideo(videoId, startSec, endSec) {
            if (!ytReady || !ytPlayer) {
                console.log('[YT] Not ready, queueing...');
                onYTReadyCallbacks.push(function () { loadYouTubeVideo(videoId, startSec, endSec); });
                return;
            }
            console.log('[YT] Loading:', videoId, 'from', startSec, 'to', endSec);
            currentVideoId = videoId;
            var opts = { videoId: videoId };
            if (startSec !== undefined && startSec !== null) opts.startSeconds = startSec;
            if (endSec !== undefined && endSec !== null) opts.endSeconds = endSec;
            ytPlayer.loadVideoById(opts);
        }

        function playYouTube() { if (ytReady && ytPlayer) ytPlayer.playVideo(); }
        function pauseYouTube() { if (ytReady && ytPlayer) ytPlayer.pauseVideo(); }
        function setYouTubeVolume(v) { if (ytReady && ytPlayer) ytPlayer.setVolume(v); }
        function getYouTubeTime() { return (ytReady && ytPlayer) ? ytPlayer.getCurrentTime() : 0; }
        function getYouTubeDuration() { return (ytReady && ytPlayer) ? ytPlayer.getDuration() : 0; }
    </script>

    <!-- Main 3D Module -->
    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
        import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
        import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';
        import { FilmPass } from 'three/addons/postprocessing/FilmPass.js';

        // ============================================================================
        // MASTER PLAYLIST - Each track has random snippets if no custom segment
        // ============================================================================
        const MASTER_PLAYLIST = [
            // YouTube tracks with optional custom start/end
            { id: 'yt_1', type: 'youtube', videoId: 'dLUClmr_Pf4', title: 'My Story', artist: 'Ethel', start: 30, end: 75 },
            { id: 'yt_2', type: 'youtube', videoId: 'zHWwhom80go', title: 'The Drop Pt.1', artist: 'Ethel', start: 15, end: 60 },
            { id: 'yt_3', type: 'youtube', videoId: 'K0ILO8MwX4Y', title: 'The Drop Pt.2', artist: 'Ethel', start: 10, end: 55 },
            { id: 'yt_4', type: 'youtube', videoId: '8rvIVBLZg2o', title: 'Structural Psychopathy', artist: 'Dominic', start: 20, end: 70 },
            { id: 'yt_5', type: 'youtube', videoId: '0sgcZRtPO6s', title: 'Ride', artist: 'Ethel', start: 25, end: 70 },
            { id: 'yt_6', type: 'youtube', videoId: '06qE_-OeIT0', title: 'Gotta Move', artist: 'Ethel', start: 10, end: 55 },
            { id: 'yt_7', type: 'youtube', videoId: 'fJNMlT7UeW0', title: 'Wont Break', artist: 'Ethel', start: 15, end: 60 },
            { id: 'yt_8', type: 'youtube', videoId: '0F_prk5dGC4', title: 'I Built A Box', artist: 'Ethel', start: 20, end: 65 },
            { id: 'yt_9', type: 'youtube', videoId: 'Ugy7KVuhwpE', title: 'Same Breath', artist: 'Dominic', start: 15, end: 60 },
            { id: 'yt_10', type: 'youtube', videoId: 'f8o7zb3F-Xk', title: 'For You', artist: 'Ethel', start: 20, end: 65 },
            { id: 'yt_11', type: 'youtube', videoId: 'YkQOXPzYkkU', title: 'Hero Killer', artist: 'Ethel', start: 25, end: 70 },
            { id: 'yt_12', type: 'youtube', videoId: 'Bff42Vyv8HM', title: 'Nothing True', artist: 'Ethel', start: 15, end: 60 },
            { id: 'yt_13', type: 'youtube', videoId: 'zh6HEd4lztU', title: 'Harms Ghost', artist: 'Ethel', start: 20, end: 65 },
            { id: 'yt_14', type: 'youtube', videoId: 'e2wt2VSi9xA', title: 'Ants on Vine', artist: 'Ethel', start: 10, end: 55 },
            { id: 'yt_15', type: 'youtube', videoId: 'ZAhqNWTHTGU', title: 'Clipboard Man', artist: 'Ethel', start: 15, end: 60 },
            { id: 'yt_16', type: 'youtube', videoId: '_gvv_W5_x10', title: 'Broken Edge', artist: 'Isla', start: 20, end: 70 },
            { id: 'yt_17', type: 'youtube', videoId: 'ey20cJsY82M', title: 'Raise Fourth', artist: 'Isla', start: 15, end: 60 },
            { id: 'yt_18', type: 'youtube', videoId: 'Y4VC6mh37NI', title: 'What You Dont See', artist: 'Isla', start: 10, end: 55 },
            { id: 'yt_19', type: 'youtube', videoId: 'NwqHLFYR1mA', title: 'Dont Wake Him', artist: 'Isla', start: 25, end: 70 },
            { id: 'yt_20', type: 'youtube', videoId: 'lwd7KOScg0k', title: 'Burning Bridge', artist: 'Isla', start: 15, end: 60 },
            { id: 'yt_21', type: 'youtube', videoId: '7gc3DigBW1Y', title: 'Hero Complex', artist: 'Dominic', start: 20, end: 65 },
            { id: 'yt_22', type: 'youtube', videoId: 'n6OgobffCzo', title: 'Thank Me Later', artist: 'Dominic', start: 10, end: 55 },
            { id: 'yt_23', type: 'youtube', videoId: '6eZwBGXGSO4', title: 'Prison Escape', artist: 'Dominic', start: 15, end: 60 },
            { id: 'yt_24', type: 'youtube', videoId: 'uovMKnwE34M', title: 'Guilt Money', artist: 'Kinley', start: 20, end: 65 },
            { id: 'yt_25', type: 'youtube', videoId: 'OxHZnnRhtbk', title: 'Normal?!', artist: 'Ethel', start: 25, end: 70 },
            { id: 'yt_26', type: 'youtube', videoId: 's9Z8dgRk-Q8', title: 'Mistake Purpose', artist: 'Ethel', start: 15, end: 60 },
            { id: 'yt_27', type: 'youtube', videoId: 'PMy76HBgpL8', title: 'Grief', artist: 'Ethel', start: 20, end: 70 },
            { id: 'yt_28', type: 'youtube', videoId: 'K9lQ0IYiMoM', title: 'Peek-A-Boo', artist: 'Isla', start: 10, end: 55 },
        ];

        // ============================================================================
        // STATE
        // ============================================================================
        let playlist = MASTER_PLAYLIST;
        let currentIdx = -1;
        let isPlaying = false;
        let shuffleOn = false;

        // THREE.js
        let scene, camera, renderer, composer, controls;
        let globeGroup, particleSystem;
        let nodeMeshes = [];
        let labelElements = [];
        let clock;
        let bassLevel = 0, midLevel = 0, highLevel = 0;

        // Simulated audio reactivity (since we can't analyze YT audio due to CORS)
        let simulatedBeat = 0;
        let beatPhase = 0;

        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();
        let hoveredNode = null;

        // ============================================================================
        // INIT
        // ============================================================================
        document.getElementById('start-screen').addEventListener('click', initApp);

        function initApp() {
            document.getElementById('start-screen').style.opacity = 0;
            setTimeout(() => document.getElementById('start-screen').remove(), 500);

            initThree();
            setupControls();
            animate();
        }

        function setupControls() {
            document.getElementById('play-btn').onclick = togglePlay;
            document.getElementById('prev-btn').onclick = prevTrack;
            document.getElementById('next-btn').onclick = nextTrack;
            document.getElementById('shuffle-btn').onclick = toggleShuffle;
            document.getElementById('volume').oninput = (e) => setYouTubeVolume(e.target.value);
        }

        // Callbacks from YouTube global scope
        window.onTrackEnded = nextTrack;
        window.onPlayStateChanged = (playing) => {
            isPlaying = playing;
            document.getElementById('play-btn').textContent = playing ? '‚è∏' : '‚ñ∂';
        };

        // ============================================================================
        // THREE.JS SETUP
        // ============================================================================
        function initThree() {
            clock = new THREE.Clock();
            scene = new THREE.Scene();
            scene.fog = new THREE.FogExp2(0x000000, 0.012);

            camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 5, 28);

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            document.body.insertBefore(renderer.domElement, document.body.firstChild);

            controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            controls.autoRotate = true;
            controls.autoRotateSpeed = 0.25;
            controls.minDistance = 12;
            controls.maxDistance = 45;

            // Post Processing
            composer = new EffectComposer(renderer);
            composer.addPass(new RenderPass(scene, camera));

            const bloom = new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.5, 0.4, 0.85);
            bloom.threshold = 0.05;
            bloom.strength = 1.6;
            bloom.radius = 0.8;
            composer.addPass(bloom);

            const film = new FilmPass(0.2, 0.35, 550, false);
            composer.addPass(film);

            createGlobe();
            createNodes();
            createParticleSystem();

            window.addEventListener('mousemove', onMouseMove);
            window.addEventListener('click', onMouseClick);
            window.addEventListener('resize', onResize);
        }

        function onResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
            composer.setSize(window.innerWidth, window.innerHeight);
        }

        function onMouseMove(e) {
            mouse.x = (e.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(e.clientY / window.innerHeight) * 2 + 1;
        }

        function onMouseClick() {
            if (hoveredNode !== null) {
                playTrack(hoveredNode);
            }
        }

        // ============================================================================
        // GLOBE - Audio reactive point cloud
        // ============================================================================
        function createGlobe() {
            globeGroup = new THREE.Group();
            scene.add(globeGroup);

            const globeRadius = 10;
            const positions = [], colors = [], sizes = [];
            const c1 = new THREE.Color(0x00ff41);
            const c2 = new THREE.Color(0x001a00);

            function noise(x, y, z) { return Math.sin(x * 4) * Math.cos(y * 4) * Math.sin(z * 4); }

            const count = 30000;
            for (let i = 0; i < count; i++) {
                const phi = Math.acos(1 - 2 * (i + 0.5) / count);
                const theta = Math.PI * (1 + Math.sqrt(5)) * (i + 0.5);
                let x = Math.cos(theta) * Math.sin(phi);
                let y = Math.sin(theta) * Math.sin(phi);
                let z = Math.cos(phi);

                if (noise(x * 2, y * 2, z * 2) > -0.35) {
                    positions.push(x * globeRadius, y * globeRadius, z * globeRadius);
                    const col = Math.random() > 0.92 ? c1 : c2;
                    colors.push(col.r, col.g, col.b);
                    sizes.push(Math.random() * 0.08 + 0.02);
                }
            }

            const geo = new THREE.BufferGeometry();
            geo.setAttribute('position', new THREE.Float32BufferAttribute(positions, 3));
            geo.setAttribute('color', new THREE.Float32BufferAttribute(colors, 3));
            geo.setAttribute('size', new THREE.Float32BufferAttribute(sizes, 1));

            const mat = new THREE.ShaderMaterial({
                uniforms: { time: { value: 0 }, bass: { value: 0 } },
                vertexShader: `
            attribute float size;
            attribute vec3 color;
            varying vec3 vColor;
            uniform float time, bass;
            void main() {
                vColor = color;
                vec3 pos = position * (1.0 + bass * 0.15);
                vec4 mv = modelViewMatrix * vec4(pos, 1.0);
                float pulse = 1.0 + bass * 1.5 * sin(time * 4.0 + position.x * 3.0);
                gl_PointSize = size * (220.0 / -mv.z) * pulse;
                gl_Position = projectionMatrix * mv;
            }
        `,
                fragmentShader: `
            varying vec3 vColor;
            void main() {
                if (length(gl_PointCoord - 0.5) > 0.45) discard;
                gl_FragColor = vec4(vColor, 0.9);
            }
        `,
                transparent: true,
                blending: THREE.AdditiveBlending,
                depthWrite: false
            });

            globeGroup.add(new THREE.Points(geo, mat));
        }

        // ============================================================================
        // NODES - Clickable track selectors
        // ============================================================================
        function createNodes() {
            const nodesGroup = new THREE.Group();
            globeGroup.add(nodesGroup);

            const nodeRadius = 11.5;

            playlist.forEach((track, i) => {
                const phi = Math.acos(1 - 2 * (i + 0.5) / playlist.length);
                const theta = Math.PI * (1 + Math.sqrt(5)) * (i + 0.5);
                const x = nodeRadius * Math.cos(theta) * Math.sin(phi);
                const y = nodeRadius * Math.sin(theta) * Math.sin(phi);
                const z = nodeRadius * Math.cos(phi);

                const pivot = new THREE.Group();
                pivot.position.set(x, y, z);
                nodesGroup.add(pivot);

                // Glowing orb
                const geo = new THREE.SphereGeometry(0.3, 12, 12);
                const mat = new THREE.MeshBasicMaterial({ color: 0x00ff41, transparent: true, opacity: 0.7 });
                const mesh = new THREE.Mesh(geo, mat);
                mesh.userData = { idx: i, track };
                pivot.add(mesh);

                // Ring
                const ringGeo = new THREE.TorusGeometry(0.5, 0.015, 8, 24);
                const ringMat = new THREE.MeshBasicMaterial({ color: 0x00ff41, transparent: true, opacity: 0.2 });
                const ring = new THREE.Mesh(ringGeo, ringMat);
                ring.rotation.x = Math.PI / 2;
                pivot.add(ring);

                nodeMeshes.push({ pivot, mesh, mat, ring, ringMat, worldPos: new THREE.Vector3(x, y, z), track });

                // Label
                const label = document.createElement('div');
                label.className = 'node-label';
                label.innerHTML = `<b>${track.title}</b><br><span style="color:#888">${track.artist}</span>`;
                document.body.appendChild(label);
                labelElements.push({ div: label, idx: i });
            });
        }

        // ============================================================================
        // PARTICLES - Beat-driven explosions
        // ============================================================================
        let particles = [];

        function createParticleSystem() {
            particleSystem = new THREE.Group();
            scene.add(particleSystem);
        }

        function spawnBurst() {
            for (let i = 0; i < 30; i++) {
                const geo = new THREE.BoxGeometry(0.1, 0.1, 0.1);
                const colors = [0x00ff41, 0x00ffff, 0xff9500];
                const mat = new THREE.MeshBasicMaterial({ color: colors[Math.floor(Math.random() * 3)], transparent: true });
                const mesh = new THREE.Mesh(geo, mat);
                const vel = new THREE.Vector3((Math.random() - 0.5), (Math.random() - 0.5), (Math.random() - 0.5)).normalize().multiplyScalar(0.25 + Math.random() * 0.15);
                particleSystem.add(mesh);
                particles.push({ mesh, vel, life: 1 });
            }
        }

        function updateParticles(delta) {
            particles = particles.filter(p => {
                p.mesh.position.add(p.vel);
                p.life -= delta * 1.8;
                p.mesh.material.opacity = p.life;
                if (p.life <= 0) { particleSystem.remove(p.mesh); return false; }
                return true;
            });
        }

        // ============================================================================
        // ANIMATION - Everything moves with the beat
        // ============================================================================
        let lastBeatTime = 0;

        function animate() {
            requestAnimationFrame(animate);
            const time = clock.getElapsedTime();
            const delta = clock.getDelta();

            // Simulated audio reactivity (BPM ~120 = beat every 0.5s)
            beatPhase = (beatPhase + delta * 2.5) % 1;
            const beatPulse = Math.pow(Math.sin(beatPhase * Math.PI), 4);

            // When playing, simulate stronger beats
            if (isPlaying) {
                bassLevel = THREE.MathUtils.lerp(bassLevel, 0.3 + beatPulse * 0.5, 0.15);
                midLevel = THREE.MathUtils.lerp(midLevel, 0.2 + beatPulse * 0.3, 0.1);
                highLevel = THREE.MathUtils.lerp(highLevel, 0.1 + beatPulse * 0.4, 0.2);
            } else {
                bassLevel = THREE.MathUtils.lerp(bassLevel, 0.05, 0.1);
                midLevel = THREE.MathUtils.lerp(midLevel, 0.05, 0.1);
                highLevel = THREE.MathUtils.lerp(highLevel, 0.05, 0.1);
            }

            // Beat explosion
            if (isPlaying && beatPulse > 0.9 && time - lastBeatTime > 0.4) {
                lastBeatTime = time;
                spawnBurst();
            }

            // Globe breathing
            globeGroup.scale.setScalar(1 + bassLevel * 0.12);
            globeGroup.rotation.y += 0.0008 + bassLevel * 0.002;
            globeGroup.children[0].material.uniforms.time.value = time;
            globeGroup.children[0].material.uniforms.bass.value = bassLevel;

            updateParticles(delta);

            // Raycast for hover
            raycaster.setFromCamera(mouse, camera);
            const meshes = nodeMeshes.map(n => n.mesh);
            const intersects = raycaster.intersectObjects(meshes);

            hoveredNode = null;
            if (intersects.length > 0) {
                hoveredNode = intersects[0].object.userData.idx;
                document.body.style.cursor = 'pointer';
                controls.autoRotate = false;
            } else {
                document.body.style.cursor = 'crosshair';
                controls.autoRotate = true;
            }

            // Update nodes
            nodeMeshes.forEach((n, i) => {
                n.mesh.lookAt(camera.position);

                const isActive = i === currentIdx;
                const isHovered = i === hoveredNode;

                // Scale with beat
                let targetScale = 1;
                if (isActive) targetScale = 1.6 + bassLevel * 0.8;
                else if (isHovered) targetScale = 1.3;
                n.mesh.scale.setScalar(THREE.MathUtils.lerp(n.mesh.scale.x, targetScale, 0.12));

                // Ring rotation speeds up with beat
                n.ring.rotation.z += isActive ? (0.02 + highLevel * 0.1) : 0.004;
                n.ringMat.opacity = isActive ? (0.6 + midLevel * 0.4) : (isHovered ? 0.4 : 0.15);

                // Color pulse
                if (isActive) {
                    const pulse = Math.sin(time * 6) * 0.2 + 0.8;
                    n.mat.opacity = pulse + highLevel * 0.3;
                } else {
                    n.mat.opacity = isHovered ? 0.85 : 0.55;
                }

                // Label position
                n.mesh.getWorldPosition(n.worldPos);
                n.worldPos.project(camera);
                const x = (n.worldPos.x * 0.5 + 0.5) * window.innerWidth;
                const y = (n.worldPos.y * -0.5 + 0.5) * window.innerHeight;
                const label = labelElements[i];
                label.div.style.transform = `translate(-50%, -50%) translate(${x}px,${y - 32}px)`;

                if (isHovered || isActive) {
                    label.div.classList.add('visible');
                    label.div.classList.toggle('active', isActive);
                } else {
                    label.div.classList.remove('visible', 'active');
                }
            });

            controls.update();
            composer.render();
        }

        // ============================================================================
        // PLAYBACK - Uses global YouTube functions
        // ============================================================================
        function playTrack(idx) {
            if (idx < 0 || idx >= playlist.length) return;
            currentIdx = idx;
            const track = playlist[idx];

            document.getElementById('np-title').textContent = track.title;
            document.getElementById('np-artist').textContent = track.artist;

            // Load with start/end times
            loadYouTubeVideo(track.videoId, track.start, track.end);
            isPlaying = true;
            document.getElementById('play-btn').textContent = '‚è∏';
        }

        function togglePlay() {
            if (currentIdx < 0) {
                playTrack(0);
                return;
            }
            if (isPlaying) {
                pauseYouTube();
            } else {
                playYouTube();
            }
        }

        function prevTrack() {
            let idx = currentIdx - 1;
            if (idx < 0) idx = playlist.length - 1;
            playTrack(idx);
        }

        function nextTrack() {
            let idx = shuffleOn ? Math.floor(Math.random() * playlist.length) : (currentIdx + 1) % playlist.length;
            playTrack(idx);
        }

        function toggleShuffle() {
            shuffleOn = !shuffleOn;
            document.getElementById('shuffle-btn').classList.toggle('active', shuffleOn);
        }
    </script>
</body>

</html>