<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>SilenceHome – Transport Sync Test (Gallery Map)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.youtube.com/iframe_api"></script>
</head>

<body class="bg-black text-gray-200 overflow-hidden">

    <!-- TOP BAR -->
    <div class="fixed top-0 left-0 right-0 h-14 bg-zinc-900 border-b border-gray-800 flex items-center px-6 z-50">
        <div class="flex gap-6 font-mono text-xs tracking-widest uppercase">
            <span class="text-gray-400">TRANSMISSION</span>
            <span class="text-gray-400">FILES</span>
            <span class="text-gray-400">SUBJECTS</span>
            <span class="text-green-500">AUDIO LOGS</span>
        </div>
    </div>

    <!-- MAIN -->
    <main class="absolute top-14 bottom-24 left-0 right-0 flex items-center justify-center">

        <!-- OUTER FRAME -->
        <div class="bg-zinc-900/60 border border-gray-800 rounded-xl overflow-hidden flex h-[600px] w-[1100px]">

            <!-- LEFT FRAME -->
            <div class="w-1/3 border-r border-gray-800 bg-black/40"></div>

            <!-- RIGHT FRAME -->
            <div class="w-2/3 relative bg-black overflow-hidden">

                <!-- STORY FRAMES (MATCH PRODUCTION IDS) -->
                <img id="story-bg-1" crossorigin="anonymous"
                    class="absolute inset-0 w-full h-full object-cover opacity-0 transition-opacity duration-500">
                <img id="story-bg-2" crossorigin="anonymous"
                    class="absolute inset-0 w-full h-full object-cover opacity-0 transition-opacity duration-500">

                <!-- YOUTUBE (AUDIO ONLY) -->
                <div id="youtube-player" allow="autoplay; encrypted-media"
                    class="absolute inset-0 z-[-1] opacity-0 pointer-events-none"></div>

                <!-- OVERLAY -->
                <div
                    class="absolute inset-0 bg-gradient-to-b from-black/30 via-black/50 to-black/70 pointer-events-none">
                </div>

            </div>
        </div>
    </main>

    <!-- TRANSPORT -->
    <div
        class="fixed bottom-0 left-0 right-0 h-24 bg-zinc-900 border-t border-gray-800 flex items-center justify-center gap-6 z-50">
        <button onclick="play()" class="w-12 h-12 rounded-full bg-white text-black">▶</button>
        <button onclick="pause()" class="w-12 h-12 rounded-full border border-gray-600">⏸</button>
        <button onclick="stop()" class="w-12 h-12 rounded-full border border-gray-600">■</button>
    </div>

    <script>
        /* ===== CONFIG ===== */
        const VIDEO_ID = "MhEeDcdscrs";
        const MAP_URL =
            "https://njsalubrious.github.io/pixelstortion-assets/assets_for_ethel_songs/gallery_map.json";
        const TRACK_KEY = "track_06";        // Polished Vomit
        const IMAGE_INTERVAL = 7000;

        /* ===== STATE ===== */
        let ytPlayer;
        let ytReady = false;
        let playing = false;
        let imageIndex = 0;
        let timer = null;
        let activeFrame = 1;
        let imageList = [];

        /* ===== FRAME ELEMENTS ===== */
        const frame1 = document.getElementById("story-bg-1");
        const frame2 = document.getElementById("story-bg-2");

        /* ===== LOAD GALLERY MAP (SOURCE OF TRUTH) ===== */
        async function loadGallery() {
            try {
                console.log("Loading gallery map...");
                const res = await fetch(MAP_URL, { cache: "no-store" });
                const map = await res.json();
                imageList = map[TRACK_KEY] || [];
                console.log("Gallery loaded:", imageList.length, "images for", TRACK_KEY);
            } catch (e) {
                console.error("Failed to load gallery:", e);
            }
        }

        /* ===== IMAGE DISPLAY ===== */
        function showImage(i) {
            if (!imageList.length) {
                console.warn("No images in list");
                return;
            }

            const url = imageList[i];
            console.log("Showing image", i, ":", url);
            const active = activeFrame === 1 ? frame1 : frame2;
            const inactive = activeFrame === 1 ? frame2 : frame1;

            active.onload = () => {
                active.classList.add("opacity-100");
                inactive.classList.remove("opacity-100");
                activeFrame = activeFrame === 1 ? 2 : 1;
            };

            active.onerror = () => {
                console.error("IMAGE LOAD FAILED:", url);
            };

            active.src = url;

            if (active.complete && active.naturalHeight !== 0) active.onload();
        }

        function startImages() {
            clearInterval(timer);
            imageIndex = 0;
            showImage(imageIndex);

            timer = setInterval(() => {
                if (!playing || !imageList.length) return;
                imageIndex = (imageIndex + 1) % imageList.length;
                showImage(imageIndex);
            }, IMAGE_INTERVAL);
        }

        function stopImages() {
            clearInterval(timer);
            timer = null;
            imageIndex = 0;
            frame1.classList.remove("opacity-100");
            frame2.classList.remove("opacity-100");
        }

        /* ===== YOUTUBE ===== */
        function onYouTubeIframeAPIReady() {
            console.log("YouTube API Ready");
            ytPlayer = new YT.Player("youtube-player", {
                videoId: VIDEO_ID,
                playerVars: {
                    autoplay: 0,
                    controls: 0,
                    disablekb: 1,
                    rel: 0,
                    playsinline: 1
                },
                events: {
                    'onReady': function (event) {
                        console.log("YouTube Player Ready");
                        ytReady = true;
                    },
                    'onStateChange': function (event) {
                        console.log("Player state:", event.data);
                    }
                }
            });
        }

        /* ===== TRANSPORT ===== */
        function play() {
            console.log("Play clicked. imageList:", imageList.length);
            if (playing) return;
            playing = true;
            startImages();
            ytPlayer.playVideo();
        }

        function pause() {
            console.log("Pause clicked");
            playing = false;
            clearInterval(timer);
            if (ytReady) ytPlayer.pauseVideo();
        }

        function stop() {
            console.log("Stop clicked");
            playing = false;
            stopImages();
            if (ytReady) {
                ytPlayer.pauseVideo();
                ytPlayer.seekTo(0, true);
            }
        }

        /* ===== INIT ===== */
        loadGallery();
    </script>

</body>

</html>