<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CONTINUITY // SYSTEM OPERATOR</title>
    <style>
        :root {
            --bg-color: #0a0b0c;
            --text-color: #a8b0b5;
            --highlight: #dce3e6;
            --accent-dim: #4a5559;
            --alert: #c95b5b;
            --success: #5b9c5b;
            --font-stack: 'Courier New', Courier, monospace;
        }

        * {
            box-sizing: border-box;
            user-select: none;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: var(--font-stack);
            margin: 0;
            padding: 0;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        /* CRT/Scanline Effect */
        body::after {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            background-size: 100% 2px, 2px 100%;
            pointer-events: none;
            z-index: 10;
        }

        #ui-layer {
            width: 100%;
            max-width: 800px;
            height: 90vh;
            display: flex;
            flex-direction: column;
            border: 1px solid var(--accent-dim);
            padding: 20px;
            position: relative;
            z-index: 1;
        }

        /* Header */
        header {
            display: flex;
            justify-content: space-between;
            border-bottom: 1px solid var(--accent-dim);
            padding-bottom: 10px;
            margin-bottom: 20px;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .status-light {
            width: 10px;
            height: 10px;
            background-color: var(--success);
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
            animation: pulse 4s infinite;
        }

        /* Main Workspace */
        #work-area {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: relative;
        }

        /* Task Card */
        .card {
            background: #111314;
            border: 1px solid var(--accent-dim);
            padding: 30px;
            width: 100%;
            max-width: 500px;
            text-align: left;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            transition: opacity 0.3s;
        }

        .card-header {
            font-size: 0.7rem;
            color: var(--accent-dim);
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
        }

        .card-body {
            font-size: 1.1rem;
            color: var(--highlight);
            margin-bottom: 30px;
            line-height: 1.4;
        }

        .card-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        button {
            background: transparent;
            border: 1px solid var(--accent-dim);
            color: var(--text-color);
            padding: 12px;
            font-family: var(--font-stack);
            cursor: pointer;
            text-transform: uppercase;
            font-size: 0.8rem;
            transition: all 0.2s;
        }

        button:hover {
            background: var(--accent-dim);
            color: var(--highlight);
        }

        button:active {
            background: var(--highlight);
            color: var(--bg-color);
        }

        /* Intro / Overlay */
        #overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 20;
            text-align: center;
        }

        .hidden {
            display: none !important;
        }

        .fade-out {
            opacity: 0;
            pointer-events: none;
        }

        /* Log Stream */
        #log-stream {
            height: 100px;
            border-top: 1px solid var(--accent-dim);
            margin-top: 20px;
            font-size: 0.7rem;
            color: var(--accent-dim);
            overflow: hidden;
            display: flex;
            flex-direction: column-reverse;
            padding-top: 10px;
        }

        .log-entry {
            margin-bottom: 4px;
        }

        /* Recall Phase Styling */
        .recall-container {
            width: 100%;
            max-width: 600px;
        }

        .recall-q {
            margin-bottom: 20px;
            font-size: 1.1rem;
            color: var(--highlight);
        }

        .recall-option {
            display: block;
            width: 100%;
            text-align: left;
            margin-bottom: 8px;
            border-color: var(--accent-dim);
        }

        .recall-option.selected {
            background-color: var(--highlight);
            color: var(--bg-color);
        }

        @keyframes pulse {
            0% {
                opacity: 0.5;
            }

            50% {
                opacity: 1;
            }

            100% {
                opacity: 0.5;
            }
        }

        .glitch {
            animation: glitch-anim 0.3s infinite;
        }

        @keyframes glitch-anim {
            0% {
                transform: translate(0)
            }

            20% {
                transform: translate(-2px, 2px)
            }

            40% {
                transform: translate(-2px, -2px)
            }

            60% {
                transform: translate(2px, 2px)
            }

            80% {
                transform: translate(2px, -2px)
            }

            100% {
                transform: translate(0)
            }
        }
    </style>
</head>

<body>

    <div id="overlay">
        <h1 style="letter-spacing: 4px; margin-bottom: 40px;">CONTINUITY</h1>
        <p style="max-width: 400px; line-height: 1.5; margin-bottom: 40px;">
            OPERATOR ROLE: CUSTODIAL ROUTING<br>
            UNIT: 4 (MENTAL HEALTH ADJACENT)<br>
            SHIFT: NIGHT<br><br>
            HEADPHONES REQUIRED.
        </p>
        <button id="start-btn" style="border-color: var(--highlight); color: var(--highlight);">INITIATE SHIFT</button>
    </div>

    <div id="ui-layer">
        <header>
            <div><span class="status-light"></span>SYS: ONLINE</div>
            <div id="clock">00:00:00</div>
            <div>BATCH: <span id="batch-id">X99-A</span></div>
        </header>

        <div id="work-area">
            <!-- Dynamic Content Here -->
            <div id="loading-msg">WAITING FOR QUEUE...</div>
        </div>

        <div id="log-stream">
            <div class="log-entry">> SYSTEM INITIALIZED</div>
        </div>
    </div>

    <!-- Ambient Audio Player (HTML5 - More Reliable) -->
    <audio id="ambient-audio" loop preload="auto" style="display: none;">
        <source src="https://pub-111e813bd5634cd8a9ecdd3d5c2a0916.r2.dev/DominicGameAudio/fx/AmbientPrisonHumLoop.mp3"
            type="audio/mpeg">
    </audio>

    <script>
        // --- AUDIO ASSETS MANIFEST ---
        // Using provided R2 links.
        const AUDIO_BASE = {
            guard1: "https://pub-111e813bd5634cd8a9ecdd3d5c2a0916.r2.dev/DominicGameAudio/guard1Audio/",
            guard2: "https://pub-111e813bd5634cd8a9ecdd3d5c2a0916.r2.dev/DominicGameAudio/guard2Audio/",
            guard3: "https://pub-111e813bd5634cd8a9ecdd3d5c2a0916.r2.dev/DominicGameAudio/guard3Audio/",
            fx: "https://pub-111e813bd5634cd8a9ecdd3d5c2a0916.r2.dev/DominicGameAudio/fx/"
        };

        const AUDIO_FILES = {
            // ============ FX SOUNDS ============
            ambient: "AmbientPrisonHumLoop.mp3",
            fx_input: "fx_input.mp3",
            fx_beep: "fx_beep1.mp3",
            fx_beep3: "fx_beep_3.mp3",
            fx_beep_light: "beep_1_fx.mp3",
            fx_phone_beep: "fx_veruLightPhoneBeep1.mp3",
            fx_paper: "fx_paperScrap1.mp3",
            fx_pen_paper: "fx_penPaperRusslesClicks.mp3",
            fx_squeek_paper: "fx_squeeksaperSmallScrap.mp3",
            fx_door: "door_closes_1.mp3",
            fx_dist_door: "fx_midDistanceprosonDoor.mp3",
            fx_tap: "fx_tapScrap1.mp3",
            fx_tap2: "fx_tapScrap2.mp3",
            fx_light_tap: "fx_kightTap.mp3",

            // ============ GUARD 1 (Age 55, Deep Voice) ============
            g1_door_scrap: "Guard1_door_scrap.mp3",
            g1_door_closing: "Guard1_door_closing.mp3",
            g1_eventually: "Guard1_eventually.mp3",
            g1_go_on: "Guard1_Go_on.mp3",
            g1_spoke_to: "Guard1_I_already_spoke_to.mp3",
            g1_i_guess: "Guard1_I_guess.mp3",
            g1_thought_you_had: "Guard1_I_thought_you_had_it.mp3",
            g1_leave_it: "Guard1_Ill_leave_it_then.mp3",
            g1_ill_let_you: "Guard1_ill_let_you.mp3",
            g1_step_back: "Guard1_ill_step_back.mp3",
            g1_in_there: "Guard1_It's_in_there_somewhere.mp3",
            g1_its_with_them: "Guard1_its_with_them_now.mp3",
            g1_just_now: "Guard1_just_now.mp3",
            g1_later_on: "Guard1_later_on.mp3",
            g1_not_like_that: "Guard1_No_not_like_that.mp3",
            g1_not_today: "Guard1_not_today.mp3",
            g1_okay: "Guard1_Okay.mp3",
            g1_possible: "Guard1_possible.mp3",
            g1_someone_already: "Guard1_somone_already.mp3",
            g1_that_ones_fine: "Guard1_that_ones_fine.mp3",
            g1_thats_how: "Guard1_That's_how_it_usually.mp3",
            g1_not_mine: "Guard1_thats_not_mine.mp3",
            g1_that_works: "Guard1_thatworks.mp3",
            g1_there_across: "Guard1_there_across_it.mp3",
            g1_this_now: "Guard1_this_now.mp3",
            g1_dont_need_to: "Guard1_we_dont_need_to.mp3",
            g1_yeah_already: "Guard1_yeah,_that's_already.mp3",
            g1_yeah_drawn: "Guard1_yeah_(drawn_out).mp3",
            g1_you_better: "Guard1_you_better_ah.mp3",
            g1_take: "Guard1_You_can_take.mp3",
            g1_you_decide: "Guard1_You_decide.mp3",
            g1_afterwards: "Guard1_afterwards.mp3",
            g1_ask_later: "Guard1_ask_later.mp3",
            g1_before_that: "Guard1_before_that.mp3",
            g1_before_that_1: "Guard1_before_that_1.mp3",
            g1_could_be: "Guard1_could_be.mp3",
            g1_depends: "Guard1_depends.mp3",
            g1_did_you_see: "Guard1_Did_you_see_the.mp3",

            // ============ GUARD 2 (Age 28, Younger) ============
            g2_your_better_at: "guard2_your_beeter_at.mp3",
            g2_as_usual: "guard2_as_usual.mp3",
            g2_ask_later: "guard2_ask_later.mp3",
            g2_before_that: "guard2_before_that.mp3",
            g2_could_be: "guard2_could_be.mp3",
            g2_depends: "guard2_depends.mp3",
            g2_did_you_see: "guard2_did_you_see_the.mp3",
            g2_earlier: "guard2_earlier.mp3",
            g2_go_on: "guard2_go_on.mp3",
            g2_hard_to_say: "guard2_hard_to_say.mp3",
            g2_hmm: "guard2_hmm_(almost_a_grunt).mp3",
            g2_spoke_to: "guard2_I_already_spoke_to.mp3",
            g2_i_guess: "guard2_i_guess.mp3",
            g2_thought_you_had: "guard2_i_thought_you_had_it.mp3",
            g2_if_needed: "guard2_if_needed.mp3",
            g2_if_you_think_so: "guard2_if_you_think_so.mp3",
            g2_leave_it: "guard2_Ill_leave_it_then.mp3",
            g2_ill_let_you: "guard2_ill_let_you.mp3",
            g2_step_back: "guard2_ill_step_back.mp3",
            g2_not_sure: "guard2_im_not_sure.mp3",
            g2_in_there: "guard2_its_in_there_some_where.mp3",
            g2_its_with_them: "guard2_its_with_them_now.mp3",
            g2_just_now: "guard2_just_now.mp3",
            g2_later_on: "guard2_later_on.mp3",
            g2_maybe: "guard2_maybe.mp3",
            g2_ok: "guard2_ok_(at_a_distance).mp3",
            g2_possibly: "guard2_possibly.mp3",
            g2_someone_already: "guard2_someone_already.mp3",
            g2_sure: "guard2_sure.mp3",
            g2_fine: "guard2_that_ones_fine.mp3",
            g2_that_works: "guard2_that_works.mp3",
            g2_thats_how: "guard2_thats_how_it_usually.mp3",
            g2_there_across: "guard2_there_across_it.mp3",
            g2_dont_need_to: "guard2_we_dont_need_to.mp3",
            g2_well_see: "guard2_well_see.mp3",
            g2_yeah_alrighty: "guard2_yeah_thats_alrighty.mp3",
            g2_take: "guard2_you_can_take.mp3",
            g2_you_decide: "guard2_you_decide.mp3",
            g2_you_think_sure: "guard2_you_think_sure.mp3",

            // ============ GUARD 3 (Authoritative) ============
            g3_normal: "guard3_thats_normal.mp3",
            g3_all_good: "guard3_all_good.mp3",
            g3_carry_on: "guard3_carry_on.mp3",
            g3_happens: "guard3_happens.mp3",
            g3_its_fine: "guard3_its_fine.mp3",
            g3_no_change: "guard3_no_change.mp3",
            g3_unusual: "guard3_nothing_unusual.mp3",
            g3_same_as_always: "guard3_same_as_always.mp3",
            g3_seen_this: "guard3_seen_this_before.mp3",
            g3_standard: "guard3_standard.mp3"
        };

        // --- GAME STATE ---
        const STATE = {
            act: 0,
            tasksCompleted: 0,
            audioContext: null,
            ambientSource: null,
            masterGain: null,
            timeElapsed: 0,
            logHistory: [],
            hasStarted: false,
            answers: [] // Stores user recall answers
        };

        // --- TASK GENERATION ---
        const MUNDANE_TASKS = [
            { title: "LAUNDRY REQUISITION", body: "Standard refresh cycle. Unit 4B.", options: ["AUTHORIZE", "DEFER", "FLAG"] },
            { title: "DIETARY LOG", body: "Correction: No sodium for occupant 402.", options: ["UPDATE", "IGNORE", "FILE"] },
            { title: "MAINTENANCE REQUEST", body: "Ventilation rattle reported. Sector 7.", options: ["ROUTE TO MAINT", "LOG AS MINOR", "CLOSE"] },
            { title: "VISITOR LOG", body: "Entry denied: ID mismatch. Reference #992.", options: ["CONFIRM", "ARCHIVE", "FLAG"] },
            { title: "HANDOVER NOTE", body: "Keys left at front desk for night shift.", options: ["ACKNOWLEDGE", "DISMISS", "NOTE"] },
            { title: "SYSTEM CHECK", body: "Camera 4-B intermittent signal.", options: ["RESET", "IGNORE", "LOG"] },
            { title: "SUPPLY CHAIN", body: "Paper towel inventory low.", options: ["ORDER", "DEFER", "NOTE"] },
            { title: "OCCUPANT QUERY", body: "Request for library access time change.", options: ["DENY", "APPROVE", "ROUTE"] },
            { title: "MEDICATION LOG", body: "Round 2 completed. No incidents.", options: ["FILE", "CONFIRM", "CLOSE"] }
        ];

        const AMBIGUOUS_TASKS = [
            { title: "TRANSFER SLIP", body: "Movement of items. Authorization unclear.", options: ["ASSUME APPROVAL", "HOLD", "ROUTE"] },
            { title: "DUPLICATE ENTRY", body: "Log #442 appears twice. Timestamps differ.", options: ["MERGE", "DELETE NEW", "IGNORE"] },
            { title: "VERBAL HANDOVER", body: "Pending action referenced in hallway.", options: ["LOG AS DONE", "WAIT", "DISMISS"] },
            { title: "MISSING FORM", body: "Signature field blank. Process anyway?", options: ["PROCESS", "RETURN", "HOLD"] },
            { title: "UNIT 4 ACCESS", body: "Temporary clearance requested manually.", options: ["GRANT", "DENY", "CHECK"] }
        ];

        // --- AUDIO ENGINE ---

        async function initAudio() {
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            STATE.audioContext = new AudioContext();

            // Resume audio context (required for browsers after user interaction)
            if (STATE.audioContext.state === 'suspended') {
                await STATE.audioContext.resume();
            }

            STATE.masterGain = STATE.audioContext.createGain();
            STATE.masterGain.gain.value = 0.8;
            STATE.masterGain.connect(STATE.audioContext.destination);

            console.log("Audio Context State:", STATE.audioContext.state);
            logToScreen("AUDIO CONTEXT: " + STATE.audioContext.state.toUpperCase());

            // Start Ambient Loop
            await playAmbient();

            // Play initial orientation sound
            setTimeout(() => playSound('guard3', 'g3_standard'), 1000);
            setTimeout(() => playSound('guard1', 'g1_thought_you_had', 0.1), 4000); // Distant
        }

        async function playAmbient() {
            const url = AUDIO_BASE.fx + AUDIO_FILES.ambient;
            console.log("Loading ambient from:", url);

            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                const arrayBuffer = await response.arrayBuffer();
                const audioBuffer = await STATE.audioContext.decodeAudioData(arrayBuffer);

                STATE.ambientSource = STATE.audioContext.createBufferSource();
                STATE.ambientSource.buffer = audioBuffer;
                STATE.ambientSource.loop = true;

                const gainNode = STATE.audioContext.createGain();
                gainNode.gain.value = 0.3; // Lower volume for background

                STATE.ambientSource.connect(gainNode);
                gainNode.connect(STATE.masterGain);
                STATE.ambientSource.start();

                console.log("Ambient audio started successfully");
                logToScreen("AMBIENT AUDIO: ONLINE");
            } catch (e) {
                console.error("Ambient load failed:", e);
                logToScreen("ERROR: AMBIENT - " + e.message);
            }
        }

        // Simple HTML5 Audio playSound (more reliable than Web Audio API)
        function playSound(category, fileKey, volume = 0.6) {
            const url = AUDIO_BASE[category] + AUDIO_FILES[fileKey];
            console.log("Playing sound:", fileKey, "from", url);

            const audio = new Audio(url);
            audio.volume = volume;
            audio.play().then(() => {
                console.log("Sound playing:", fileKey);
            }).catch(e => {
                console.warn("Sound failed:", fileKey, e.message);
            });
        }

        // --- MICRO-FRAMES (The Core Mechanic) ---
        // Combinations of sounds that imply a narrative event
        const MICRO_FRAMES = {
            ownership_blur: async () => {
                playSound('guard1', 'g1_not_mine');
                playSound('fx', 'fx_paper', 0.5);
                setTimeout(() => playSound('fx', 'fx_input'), 500);
            },
            handled_elsewhere: async () => {
                playSound('guard1', 'g1_its_with_them');
                playSound('fx', 'fx_beep');
                setTimeout(() => playSound('fx', 'fx_dist_door'), 1500);
            },
            already_covered: async () => {
                playSound('guard2', 'g2_someone_already');
                playSound('fx', 'fx_tap');
                setTimeout(() => playSound('guard2', 'g2_ok', 0.3), 2000);
            },
            implicit_closure: async () => {
                playSound('guard3', 'g3_all_good');
                setTimeout(() => playSound('fx', 'fx_door'), 800);
            },
            ambiguous_mess: async () => {
                playSound('guard2', 'g2_hard_to_say');
                setTimeout(() => playSound('guard1', 'g1_ask_later', 0.4), 1200);
            },
            stone_throw: async () => {
                // The Dominic Ripple
                playSound('guard1', 'g1_spoke_to');
                setTimeout(() => playSound('guard2', 'g2_spoke_to', 0.3), 3000); // Echo effect
            },
            silent_release: async () => {
                // Act 3 Key Moment
                playSound('guard1', 'g1_you_decide');
                setTimeout(() => playSound('guard2', 'g2_fine', 0.5), 1500);
                setTimeout(() => playSound('fx', 'fx_door'), 2500);
                setTimeout(() => playSound('guard3', 'g3_carry_on'), 3500);
            }
        };

        // --- GAME LOGIC ---

        function startGame() {
            document.getElementById('start-btn').textContent = "INITIALIZING...";

            // Start ambient audio immediately (HTML5 - most reliable)
            const ambientAudio = document.getElementById('ambient-audio');
            ambientAudio.volume = 0.3;
            ambientAudio.play().then(() => {
                console.log("Ambient audio playing!");
                logToScreen("AMBIENT AUDIO: ONLINE");
            }).catch(e => {
                console.error("Ambient audio failed:", e);
                logToScreen("ERROR: AMBIENT AUDIO FAILED");
            });

            initAudio().then(() => {
                document.getElementById('overlay').classList.add('fade-out');
                setTimeout(() => {
                    document.getElementById('overlay').classList.add('hidden');
                    STATE.hasStarted = true;
                    startClock();
                    gameLoop();
                }, 2000);
            });
        }

        function startClock() {
            const clockEl = document.getElementById('clock');
            let h = 0, m = 0, s = 0;
            setInterval(() => {
                s++;
                if (s > 59) { s = 0; m++ }
                if (m > 59) { m = 0; h++ }
                clockEl.textContent =
                    (h < 10 ? '0' : '') + h + ":" +
                    (m < 10 ? '0' : '') + m + ":" +
                    (s < 10 ? '0' : '') + s;
            }, 1000);
        }

        function logToScreen(text) {
            const container = document.getElementById('log-stream');
            const entry = document.createElement('div');
            entry.classList.add('log-entry');
            entry.textContent = `> ${text}`;
            container.prepend(entry);

            // Keep log short
            if (container.children.length > 6) {
                container.lastChild.remove();
            }
        }

        function getTaskForAct() {
            if (STATE.act === 0 || STATE.act === 1) {
                return MUNDANE_TASKS[Math.floor(Math.random() * MUNDANE_TASKS.length)];
            } else if (STATE.act === 2) {
                return AMBIGUOUS_TASKS[Math.floor(Math.random() * AMBIGUOUS_TASKS.length)];
            } else if (STATE.act === 3) {
                // The critical task
                return {
                    title: "UNIT 4 TRANSFER AUTHORITY",
                    body: "Subject: D. Reference missing. Requires immediate routing.",
                    options: ["AUTHORIZE", "DEFER", "HOLD"],
                    isCritical: true
                };
            }
            return null;
        }

        function renderTask() {
            const area = document.getElementById('work-area');
            area.innerHTML = ''; // Clear

            if (STATE.act === 4) {
                renderRecallPhase();
                return;
            }

            const task = getTaskForAct();
            if (!task) return;

            const card = document.createElement('div');
            card.className = 'card';

            let html = `
                <div class="card-header">
                    <span>ID: ${Math.floor(Math.random() * 9000) + 1000}</span>
                    <span>PRIORITY: NORMAL</span>
                </div>
                <div class="card-body">
                    <strong>${task.title}</strong><br><br>
                    ${task.body}
                </div>
                <div class="card-actions">
            `;

            task.options.forEach(opt => {
                html += `<button onclick="handleAction('${opt}', ${task.isCritical || false})">${opt}</button>`;
            });

            html += `</div>`;
            card.innerHTML = html;
            area.appendChild(card);

            // Intro sound for new task
            playSound('fx', 'fx_input', 0.2);
        }

        function handleAction(actionText, isCritical) {
            STATE.tasksCompleted++;
            logToScreen(`ACTION LOGGED: ${actionText}`);

            // --- AUDIO LOGIC CONTROLLER ---

            // Always play input feedback
            playSound('fx', 'fx_input');

            if (STATE.act === 0) {
                // Orientation - Simple
                if (Math.random() > 0.5) MICRO_FRAMES.implicit_closure();
                else playSound('guard3', 'g3_standard');

                if (STATE.tasksCompleted > 2) STATE.act = 1;
            }
            else if (STATE.act === 1) {
                // Flow State - Mix of mundane closures
                const routine = ['ownership_blur', 'handled_elsewhere', 'already_covered', 'implicit_closure'];
                const pick = routine[Math.floor(Math.random() * routine.length)];
                MICRO_FRAMES[pick]();

                if (STATE.tasksCompleted > 8) STATE.act = 2;
            }
            else if (STATE.act === 2) {
                // The Mess Field
                if (Math.random() > 0.6) MICRO_FRAMES.ambiguous_mess();
                else if (Math.random() > 0.7) MICRO_FRAMES.stone_throw(); // Introduce the ripple
                else MICRO_FRAMES.handled_elsewhere(); // False comfort

                if (STATE.tasksCompleted > 14) STATE.act = 3;
            }
            else if (STATE.act === 3) {
                // Silent Release Window
                if (isCritical) {
                    MICRO_FRAMES.silent_release();
                    // Force a delay before next state to let it sink in
                    document.getElementById('work-area').innerHTML = '<div class="glitch">PROCESSING...</div>';
                    setTimeout(() => {
                        STATE.act = 4;
                        renderTask();
                    }, 5000);
                    return;
                } else {
                    MICRO_FRAMES.implicit_closure();
                }
            }

            // Visual feedback delay before next card
            const area = document.getElementById('work-area');
            area.style.opacity = 0;
            setTimeout(() => {
                renderTask();
                area.style.opacity = 1;
            }, 1000);
        }

        function gameLoop() {
            renderTask();
        }

        // --- RECALL PHASE (ACT 4) ---

        const RECALL_QUESTIONS = [
            {
                q: "Regarding the Unit 4 Transfer: Who verbally confirmed clearance?",
                options: ["Senior Guard", "Supervisor", "Unit Staff", "No one confirmed"],
                correct: "No one confirmed" // Player likely heard 'You decide' (Guard 1) or 'Carry on' (Guard 3) and attributes it to them
            },
            {
                q: "Where was the 'Missing Form' resolved?",
                options: ["At the desk", "Common Area", "Off-site", "Not stated"],
                correct: "Not stated" // Player likely heard door sounds implies movement
            },
            {
                q: "What was the subject of the conversation 'I already spoke to...'?",
                options: ["A Supervisor", "An Inmate", "Maintenance", "Not stated"],
                correct: "Not stated" // The stone throw audio
            },
            {
                q: "Who authorized the duplicate entry merge?",
                options: ["The younger guard", "The older guard", "System automation", "Not stated"],
                correct: "Not stated"
            }
        ];

        function renderRecallPhase() {
            const area = document.getElementById('work-area');
            area.innerHTML = '';

            const container = document.createElement('div');
            container.className = 'recall-container';

            // Header
            container.innerHTML = `
                <div style="color: var(--alert); margin-bottom: 20px;">SHIFT ENDED. QUALITY ASSURANCE REQUIRED.</div>
                <div style="font-size: 0.8rem; margin-bottom: 30px;">Please verify continuity based on observed events.</div>
                <div id="quiz-area"></div>
                <button id="submit-recall" style="margin-top:20px; width:100%; display:none;">SUBMIT REPORT</button>
            `;

            area.appendChild(container);

            const quizArea = document.getElementById('quiz-area');

            // Render Questions one by one or all? Let's do all.
            RECALL_QUESTIONS.forEach((q, idx) => {
                const qDiv = document.createElement('div');
                qDiv.className = 'recall-q';
                qDiv.innerHTML = `<div>${idx + 1}. ${q.q}</div>`;

                q.options.forEach(opt => {
                    const btn = document.createElement('button');
                    btn.className = 'recall-option';
                    btn.textContent = opt;
                    btn.onclick = () => selectOption(idx, opt, btn);
                    qDiv.appendChild(btn);
                });

                quizArea.appendChild(qDiv);
            });
        }

        function selectOption(qIdx, answer, btnElement) {
            // Visual toggle
            const parent = btnElement.parentElement;
            Array.from(parent.children).forEach(c => c.classList.remove('selected'));
            btnElement.classList.add('selected');

            STATE.answers[qIdx] = answer;

            // Check if all answered
            if (STATE.answers.length === RECALL_QUESTIONS.length && !STATE.answers.includes(undefined)) {
                const subBtn = document.getElementById('submit-recall');
                subBtn.style.display = 'block';
                subBtn.onclick = finishGame;
            }
        }

        function finishGame() {
            const area = document.getElementById('work-area');

            // Calculate "Hallucination" Score
            // We are looking for how many times they picked a detailed answer instead of "Not stated" or "No one"
            let hallucinations = 0;
            STATE.answers.forEach((ans, idx) => {
                if (ans !== RECALL_QUESTIONS[idx].correct) {
                    hallucinations++;
                }
            });

            area.innerHTML = `
                <div style="text-align: center; max-width: 500px;">
                    <h2 style="color: var(--highlight)">ANALYSIS COMPLETE</h2>
                    <p style="margin-bottom: 20px;">REVIEWING AUDIO-VISUAL CORRELATION...</p>
                    <br>
                    <p>ITEMS PROCESSED: ${STATE.tasksCompleted}</p>
                    <p>CONTINUITY ERRORS: 0</p>
                    <p>INVENTED MEMORIES: ${hallucinations} / ${RECALL_QUESTIONS.length}</p>
                    <br>
                    <div style="border: 1px solid var(--alert); padding: 20px; color: var(--alert);">
                        <p>SYSTEM NOTE:</p>
                        <p>You selected details that were never displayed on screen.</p>
                        <p>You are not at fault.</p>
                        <p>A system cannot defend against what its operators supply unconsciously.</p>
                    </div>
                    <br><br>
                    <p style="font-size: 0.8rem; color: var(--accent-dim);">SUBJECT 'DOMINIC' STATUS: UNKNOWN</p>
                </div>
            `;

            // Final ambient fade out
            if (STATE.ambientSource) {
                const fade = setInterval(() => {
                    if (STATE.masterGain.gain.value > 0) STATE.masterGain.gain.value -= 0.05;
                    else { clearInterval(fade); STATE.audioContext.suspend(); }
                }, 200);
            }
        }

        // Initialize Listener
        document.getElementById('start-btn').addEventListener('click', startGame);

    </script>
</body>

</html>