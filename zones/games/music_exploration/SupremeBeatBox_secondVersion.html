<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>SUPREME BEAT BOX // 3D AUDIO VISUALIZER</title>
    <style>
        :root {
            --neon-green: #00ff41;
            --neon-amber: #ff9500;
            --neon-cyan: #00ffff;
            --neon-red: #ff4444;
            --bg-dark: #050505;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            overflow: hidden;
            background: var(--bg-dark);
            font-family: 'Courier New', monospace;
            color: var(--neon-green);
        }

        /* UI LAYER */
        #ui-layer {
            position: fixed;
            inset: 0;
            pointer-events: none;
            z-index: 100;
        }

        .hud-panel {
            position: absolute;
            background: rgba(0, 10, 0, 0.85);
            border: 1px solid var(--neon-green);
            padding: 12px;
            pointer-events: auto;
            backdrop-filter: blur(6px);
        }

        /* TOP HUD */
        #top-bar {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            padding: 15px 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(to bottom, rgba(0, 0, 0, 0.95), transparent);
            border-bottom: 1px solid rgba(0, 255, 65, 0.3);
        }

        .title {
            font-size: 20px;
            font-weight: bold;
            letter-spacing: 5px;
            text-shadow: 0 0 15px var(--neon-green);
        }

        .blink {
            animation: blinker 1s infinite;
        }

        @keyframes blinker {
            50% {
                opacity: 0;
            }
        }

        /* LYRICS DISPLAY */
        #lyrics-panel {
            position: absolute;
            bottom: 130px;
            left: 50%;
            transform: translateX(-50%);
            max-width: 600px;
            width: 90%;
            text-align: center;
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid rgba(0, 255, 65, 0.4);
            padding: 20px;
            font-size: 14px;
            line-height: 1.8;
            color: var(--neon-green);
            text-shadow: 0 0 8px var(--neon-green);
            opacity: 0;
            transition: opacity 0.5s;
            pointer-events: none;
        }

        #lyrics-panel.visible {
            opacity: 1;
        }

        /* CONTROL BAR */
        #control-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 110px;
            background: linear-gradient(to top, rgba(0, 0, 0, 0.98), rgba(0, 0, 0, 0.85));
            border-top: 1px solid #222;
            padding: 10px 25px;
            display: flex;
            flex-direction: column;
            pointer-events: auto;
        }

        /* Progress */
        #progress-bar {
            width: 100%;
            height: 5px;
            background: #1a1a1a;
            cursor: pointer;
            margin-bottom: 8px;
        }

        #progress-fill {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, var(--neon-green), var(--neon-cyan));
            box-shadow: 0 0 10px var(--neon-green);
            transition: width 0.1s linear;
        }

        .time-row {
            display: flex;
            justify-content: space-between;
            font-size: 10px;
            color: #555;
            margin-bottom: 8px;
        }

        .controls-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex: 1;
        }

        .track-info {
            flex: 1;
            overflow: hidden;
        }

        .track-label {
            font-size: 9px;
            color: var(--neon-green);
            margin-bottom: 2px;
        }

        .track-title {
            font-size: 13px;
            color: #fff;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 350px;
        }

        .btn-group {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .ctrl-btn {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            border: 1px solid #333;
            background: transparent;
            color: #888;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .ctrl-btn:hover {
            border-color: var(--neon-green);
            color: var(--neon-green);
            box-shadow: 0 0 15px rgba(0, 255, 65, 0.4);
        }

        .ctrl-btn.play-btn {
            width: 50px;
            height: 50px;
            border-width: 2px;
        }

        .ctrl-btn.active {
            background: var(--neon-green);
            color: #000;
            border-color: var(--neon-green);
        }

        .volume-slider {
            width: 70px;
            height: 4px;
            -webkit-appearance: none;
            background: #333;
            border-radius: 2px;
            cursor: pointer;
        }

        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 12px;
            height: 12px;
            background: var(--neon-green);
            border-radius: 50%;
        }

        /* PLAYLIST PANEL */
        #playlist-panel {
            position: fixed;
            top: 0;
            right: -340px;
            width: 340px;
            height: 100%;
            background: rgba(5, 5, 5, 0.98);
            border-left: 1px solid #222;
            z-index: 200;
            transition: right 0.3s;
            display: flex;
            flex-direction: column;
            pointer-events: auto;
        }

        #playlist-panel.open {
            right: 0;
        }

        .playlist-header {
            padding: 18px;
            border-bottom: 1px solid #222;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .playlist-header h2 {
            font-size: 12px;
            color: var(--neon-green);
            letter-spacing: 2px;
        }

        .close-btn {
            background: none;
            border: none;
            color: #666;
            font-size: 24px;
            cursor: pointer;
        }

        .close-btn:hover {
            color: var(--neon-red);
        }

        .playlist-filters {
            display: flex;
            padding: 10px;
            gap: 5px;
            flex-wrap: wrap;
            border-bottom: 1px solid #222;
        }

        .filter-btn {
            padding: 6px 10px;
            font-size: 9px;
            border: 1px solid #333;
            background: transparent;
            color: #666;
            cursor: pointer;
            text-transform: uppercase;
            transition: all 0.2s;
        }

        .filter-btn:hover {
            border-color: #666;
            color: #aaa;
        }

        .filter-btn.active {
            background: var(--neon-green);
            color: #000;
            border-color: var(--neon-green);
        }

        .playlist-tracks {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .track-item {
            padding: 10px;
            border-bottom: 1px solid #1a1a1a;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .track-item:hover {
            background: #111;
        }

        .track-item.active {
            background: rgba(0, 255, 65, 0.1);
            border-left: 2px solid var(--neon-green);
        }

        .track-idx {
            font-size: 10px;
            color: #444;
            width: 25px;
        }

        .track-item.active .track-idx {
            color: var(--neon-green);
        }

        .track-name {
            font-size: 11px;
            color: #aaa;
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .track-item.active .track-name {
            color: #fff;
        }

        .track-type {
            font-size: 8px;
            padding: 2px 5px;
            border-radius: 2px;
            text-transform: uppercase;
        }

        .track-type.youtube {
            background: #c00;
            color: #fff;
        }

        .track-type.audio {
            background: var(--neon-cyan);
            color: #000;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #000;
        }

        ::-webkit-scrollbar-thumb {
            background: #333;
            border-radius: 3px;
        }

        /* START SCREEN */
        #start-screen {
            position: fixed;
            inset: 0;
            background: #000;
            z-index: 500;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .start-title {
            font-size: 32px;
            letter-spacing: 8px;
            color: var(--neon-green);
            text-shadow: 0 0 30px var(--neon-green);
            margin-bottom: 10px;
        }

        .start-sub {
            color: #555;
            font-size: 11px;
            letter-spacing: 3px;
            margin-bottom: 30px;
        }

        .start-btn {
            border: 1px solid var(--neon-green);
            padding: 12px 35px;
            font-size: 11px;
            color: var(--neon-green);
        }

        /* Node Labels */
        .node-label {
            position: absolute;
            font-size: 10px;
            background: rgba(0, 0, 0, 0.85);
            padding: 3px 8px;
            border: 1px solid var(--neon-green);
            opacity: 0;
            transition: opacity 0.2s;
            pointer-events: none;
            white-space: nowrap;
        }

        .node-label.visible {
            opacity: 1;
        }
    </style>
    <script type="importmap">
    {
        "imports": {
            "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
            "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
        }
    }
    </script>
</head>

<body>

    <!-- UI LAYER -->
    <div id="ui-layer">
        <div id="top-bar">
            <div class="title">SUPREME BEAT BOX <span class="blink">_3D</span></div>
            <div style="font-size: 11px; text-align: right;">
                TRACKS: <span id="track-count">0</span><br>
                <span id="status-text">INITIALIZING</span>
            </div>
        </div>

        <div id="lyrics-panel"></div>

        <div id="control-bar">
            <div id="progress-bar" onclick="seekTo(event)">
                <div id="progress-fill"></div>
            </div>
            <div class="time-row">
                <span id="time-cur">0:00</span>
                <span id="time-dur">0:00</span>
            </div>
            <div class="controls-row">
                <div class="track-info">
                    <div class="track-label">CURRENT FEED</div>
                    <div class="track-title" id="current-title">LOADING...</div>
                </div>
                <div class="btn-group">
                    <button class="ctrl-btn" onclick="prevTrack()">‚èÆ</button>
                    <button class="ctrl-btn play-btn" id="play-btn" onclick="togglePlay()">‚ñ∂</button>
                    <button class="ctrl-btn" onclick="nextTrack()">‚è≠</button>
                    <button class="ctrl-btn" id="shuffle-btn" onclick="toggleShuffle()">üîÄ</button>
                </div>
                <div class="btn-group">
                    <span style="font-size:12px;">üîä</span>
                    <input type="range" class="volume-slider" id="volume" min="0" max="100" value="80"
                        oninput="setVolume(this.value)">
                    <button class="ctrl-btn" onclick="togglePlaylist()">‚ò∞</button>
                </div>
            </div>
        </div>
    </div>

    <!-- PLAYLIST PANEL -->
    <div id="playlist-panel">
        <div class="playlist-header">
            <h2>MASTER PLAYLIST</h2>
            <button class="close-btn" onclick="togglePlaylist()">√ó</button>
        </div>
        <div class="playlist-filters">
            <button class="filter-btn active" data-filter="all" onclick="setFilter('all')">ALL</button>
            <button class="filter-btn" data-filter="songs" onclick="setFilter('songs')">SONGS</button>
            <button class="filter-btn" data-filter="ryker" onclick="setFilter('ryker')">RYKER</button>
        </div>
        <div class="playlist-tracks" id="playlist-tracks"></div>
    </div>

    <!-- START SCREEN -->
    <div id="start-screen">
        <div class="start-title">SUPREME BEAT BOX</div>
        <div class="start-sub">3D AUDIO VISUALIZER // PIXELSTORTION</div>
        <div class="start-btn blink">[ CLICK TO ENTER ]</div>
    </div>

    <!-- Hidden YouTube Player -->
    <div id="yt-container" style="position:fixed;top:-9999px;left:-9999px;">
        <div id="yt-player"></div>
    </div>

    <!-- Hidden HTML5 Audio -->
    <audio id="html5-audio" preload="auto" crossorigin="anonymous"></audio>

    <script src="https://www.youtube.com/iframe_api"></script>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
        import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
        import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';
        import { FilmPass } from 'three/addons/postprocessing/FilmPass.js';

        // ============================================================================
        // USER CONFIG - EDITABLE SONG SEGMENTS
        // ============================================================================
        const SONG_SEGMENTS = {
            // 'videoId': { start: seconds, end: seconds }
            // Example: 'dLUClmr_Pf4': { start: 30, end: 90 },
        };

        // ============================================================================
        // CDN PATHS
        // ============================================================================
        const R2_AUDIO = 'https://pub-111e813bd5634cd8a9ecdd3d5c2a0916.r2.dev/dominicGlobaleNetworkAudio/';
        const R2_PICS = 'https://pub-111e813bd5634cd8a9ecdd3d5c2a0916.r2.dev/dominicGlobaleNetworkProfilePics/';

        // ============================================================================
        // MASTER PLAYLIST
        // ============================================================================
        const MASTER_PLAYLIST = [
            // SONGS (YouTube)
            { id: 'yt_1', type: 'youtube', videoId: 'dLUClmr_Pf4', title: 'My Story', artist: 'Ethel', category: 'songs' },
            { id: 'yt_2', type: 'youtube', videoId: 'zHWwhom80go', title: 'The Drop Pt.1', artist: 'Ethel', category: 'songs' },
            { id: 'yt_3', type: 'youtube', videoId: 'K0ILO8MwX4Y', title: 'The Drop Pt.2', artist: 'Ethel', category: 'songs' },
            { id: 'yt_4', type: 'youtube', videoId: '8rvIVBLZg2o', title: 'Structural Psychopathy', artist: 'Dominic', category: 'songs' },
            { id: 'yt_5', type: 'youtube', videoId: '0sgcZRtPO6s', title: 'Ride', artist: 'Ethel', category: 'songs' },
            { id: 'yt_6', type: 'youtube', videoId: '06qE_-OeIT0', title: 'Gotta Move', artist: 'Ethel', category: 'songs' },
            { id: 'yt_7', type: 'youtube', videoId: 'fJNMlT7UeW0', title: 'Wont Break', artist: 'Ethel', category: 'songs' },
            { id: 'yt_8', type: 'youtube', videoId: '0F_prk5dGC4', title: 'I Built A Box', artist: 'Ethel', category: 'songs' },
            { id: 'yt_9', type: 'youtube', videoId: 'Ugy7KVuhwpE', title: 'Same Breath', artist: 'Dominic', category: 'songs' },
            { id: 'yt_10', type: 'youtube', videoId: 'f8o7zb3F-Xk', title: 'For You', artist: 'Ethel', category: 'songs' },
            { id: 'yt_11', type: 'youtube', videoId: 'YkQOXPzYkkU', title: 'Hero Killer', artist: 'Ethel', category: 'songs' },
            { id: 'yt_12', type: 'youtube', videoId: 'Bff42Vyv8HM', title: 'Nothing True', artist: 'Ethel', category: 'songs' },
            { id: 'yt_13', type: 'youtube', videoId: 'zh6HEd4lztU', title: 'Harms Ghost', artist: 'Ethel', category: 'songs' },
            { id: 'yt_14', type: 'youtube', videoId: 'e2wt2VSi9xA', title: 'Ants on Vine', artist: 'Ethel', category: 'songs' },
            { id: 'yt_15', type: 'youtube', videoId: 'ZAhqNWTHTGU', title: 'Clipboard Man', artist: 'Ethel', category: 'songs' },
            { id: 'yt_16', type: 'youtube', videoId: 's9Z8dgRk-Q8', title: 'Mistake Purpose', artist: 'Ethel', category: 'songs' },
            { id: 'yt_17', type: 'youtube', videoId: 'OxHZnnRhtbk', title: 'Normal?!', artist: 'Ethel', category: 'songs' },
            { id: 'yt_18', type: 'youtube', videoId: '_gvv_W5_x10', title: 'Broken Edge', artist: 'Isla', category: 'songs' },
            { id: 'yt_19', type: 'youtube', videoId: 'ey20cJsY82M', title: 'Raise Fourth', artist: 'Isla', category: 'songs' },
            { id: 'yt_20', type: 'youtube', videoId: 'Y4VC6mh37NI', title: 'What You Dont See', artist: 'Isla', category: 'songs' },
            { id: 'yt_21', type: 'youtube', videoId: 'Aw2ZAkxp6b0', title: 'Give It Back', artist: 'Isla', category: 'songs' },
            { id: 'yt_22', type: 'youtube', videoId: 'NwqHLFYR1mA', title: 'Dont Wake Him', artist: 'Isla', category: 'songs' },
            { id: 'yt_23', type: 'youtube', videoId: 'X9EUb1_QC9c', title: 'Always For', artist: 'Isla', category: 'songs' },
            // RYKER NODES (R2 WAV)
            { id: 'rk_1', type: 'audio', url: R2_AUDIO + 'The%20Griever.%20Location-%20London.%20Focus-%20Liquidity.wav', title: 'The Griever', artist: 'Ryker', category: 'ryker', img: 'The Griever. Location- London. Focus- Liquidity.jpg' },
            { id: 'rk_2', type: 'audio', url: R2_AUDIO + 'Marcus%20Vane.%20Location-%20Zurich.%20Cortisol-%20High.%20Focus-%20Transaction%20Velocity.wav', title: 'Marcus Vane', artist: 'Ryker', category: 'ryker', img: 'Marcus Vane. Location- Zurich. Cortisol- High. Focus- Transaction Velocity.jpg' },
            { id: 'rk_3', type: 'audio', url: R2_AUDIO + 'Lars%20Vinter.%20Location-%20Tallinn.%20Estonia%20Focus-%20Chain%20Analysis.wav', title: 'Lars Vinter', artist: 'Ryker', category: 'ryker' },
            { id: 'rk_4', type: 'audio', url: R2_AUDIO + 'Julian%20Moretti.%20Location-%20Miami.%20Focus-%20The%20Spread.wav', title: 'Julian Moretti', artist: 'Ryker', category: 'ryker' },
            { id: 'rk_5', type: 'audio', url: R2_AUDIO + 'Inspector%20Klaus%20Weber.%20Location-%20Berlin.%20Focus-%20Chain%20of%20Custody.wav', title: 'Insp Weber', artist: 'Ryker', category: 'ryker' },
            { id: 'rk_6', type: 'audio', url: R2_AUDIO + 'Lachlan%20Sterling.%20CEO%20Apexian.%20Location-%20Barangaroo%20Penthouse.%20Cortisol-%20Low.%20Focus-%20Floor%20Space%20Ratio.wav', title: 'Lachlan Sterling', artist: 'Ryker', category: 'ryker' },
        ];

        // ============================================================================
        // STATE
        // ============================================================================
        let playlist = [...MASTER_PLAYLIST];
        let currentIdx = 0;
        let isPlaying = false;
        let shuffleOn = false;
        let ytPlayer = null;
        let ytReady = false;
        let audioEl = null;
        let audioCtx = null;
        let analyser = null;
        let freqData = null;

        // THREE.js
        let scene, camera, renderer, composer, controls;
        let globeGroup, nodesGroup, particleSystem;
        let nodeMeshes = [];
        let labelElements = [];
        let clock;
        let audioUniform = { value: 0 };
        let bassUniform = { value: 0 };
        let highUniform = { value: 0 };

        // ============================================================================
        // INIT
        // ============================================================================
        document.getElementById('start-screen').addEventListener('click', initApp);

        async function initApp() {
            document.getElementById('start-screen').style.opacity = 0;
            setTimeout(() => document.getElementById('start-screen').remove(), 500);

            audioEl = document.getElementById('html5-audio');
            initAudio();
            initThree();
            renderPlaylist();
            document.getElementById('track-count').textContent = playlist.length;
            document.getElementById('status-text').textContent = 'ONLINE';
            loadTrack(0);
            animate();
        }

        // YouTube API
        window.onYouTubeIframeAPIReady = function () {
            ytPlayer = new YT.Player('yt-player', {
                height: '1', width: '1',
                playerVars: { autoplay: 0, controls: 0 },
                events: {
                    onReady: () => { ytReady = true; },
                    onStateChange: onYTState,
                    onError: () => window.nextTrack()
                }
            });
        };

        function onYTState(e) {
            if (e.data === YT.PlayerState.ENDED) window.nextTrack();
            else if (e.data === YT.PlayerState.PLAYING) { isPlaying = true; updatePlayBtn(); }
            else if (e.data === YT.PlayerState.PAUSED) { isPlaying = false; updatePlayBtn(); }
        }

        // ============================================================================
        // AUDIO ANALYSIS
        // ============================================================================
        function initAudio() {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            analyser = audioCtx.createAnalyser();
            analyser.fftSize = 256;
            freqData = new Uint8Array(analyser.frequencyBinCount);

            const source = audioCtx.createMediaElementSource(audioEl);
            source.connect(analyser);
            analyser.connect(audioCtx.destination);
        }

        function getAudioLevels() {
            if (!analyser) return { bass: 0, mid: 0, high: 0, avg: 0 };
            analyser.getByteFrequencyData(freqData);
            const bass = freqData.slice(0, 6).reduce((a, b) => a + b, 0) / 6 / 255;
            const mid = freqData.slice(6, 20).reduce((a, b) => a + b, 0) / 14 / 255;
            const high = freqData.slice(20, 50).reduce((a, b) => a + b, 0) / 30 / 255;
            return { bass, mid, high, avg: (bass + mid + high) / 3 };
        }

        // ============================================================================
        // THREE.JS SETUP
        // ============================================================================
        function initThree() {
            clock = new THREE.Clock();
            scene = new THREE.Scene();
            scene.fog = new THREE.FogExp2(0x000000, 0.018);

            camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 8, 28);

            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            document.body.insertBefore(renderer.domElement, document.body.firstChild);

            controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            controls.autoRotate = true;
            controls.autoRotateSpeed = 0.4;
            controls.minDistance = 15;
            controls.maxDistance = 55;

            // Post Processing
            composer = new EffectComposer(renderer);
            composer.addPass(new RenderPass(scene, camera));

            const bloom = new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.5, 0.4, 0.85);
            bloom.threshold = 0.1;
            bloom.strength = 1.4;
            bloom.radius = 0.6;
            composer.addPass(bloom);

            const film = new FilmPass(0.3, 0.4, 600, false);
            composer.addPass(film);

            // Create Globe
            createGlobe();
            createNodes();
            createParticleSystem();

            window.addEventListener('resize', onResize);
        }

        function onResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
            composer.setSize(window.innerWidth, window.innerHeight);
        }

        // ============================================================================
        // THE GLOBE (Point Cloud)
        // ============================================================================
        function createGlobe() {
            globeGroup = new THREE.Group();
            scene.add(globeGroup);

            const globeRadius = 10;
            const positions = [], colors = [], sizes = [];
            const c1 = new THREE.Color(0x00ff41);
            const c2 = new THREE.Color(0x003300);

            function noise(x, y, z) {
                return Math.sin(x * 5) * Math.cos(y * 5) * Math.sin(z * 5);
            }

            const count = 40000;
            for (let i = 0; i < count; i++) {
                const phi = Math.acos(1 - 2 * (i + 0.5) / count);
                const theta = Math.PI * (1 + Math.sqrt(5)) * (i + 0.5);
                let x = Math.cos(theta) * Math.sin(phi);
                let y = Math.sin(theta) * Math.sin(phi);
                let z = Math.cos(phi);

                if (noise(x * 2, y * 2, z * 2) > -0.25) {
                    positions.push(x * globeRadius, y * globeRadius, z * globeRadius);
                    const col = Math.random() > 0.85 ? c1 : c2;
                    colors.push(col.r, col.g, col.b);
                    sizes.push(Math.random() * 0.12 + 0.03);
                }
            }

            const geo = new THREE.BufferGeometry();
            geo.setAttribute('position', new THREE.Float32BufferAttribute(positions, 3));
            geo.setAttribute('color', new THREE.Float32BufferAttribute(colors, 3));
            geo.setAttribute('size', new THREE.Float32BufferAttribute(sizes, 1));

            const mat = new THREE.ShaderMaterial({
                uniforms: {
                    time: { value: 0 },
                    audioBass: bassUniform
                },
                vertexShader: `
            attribute float size;
            attribute vec3 color;
            varying vec3 vColor;
            uniform float time;
            uniform float audioBass;
            void main() {
                vColor = color;
                vec3 pos = position * (1.0 + audioBass * 0.15);
                vec4 mv = modelViewMatrix * vec4(pos, 1.0);
                float pulse = 1.0 + audioBass * 1.5 * sin(time * 4.0 + position.x * 2.0);
                gl_PointSize = size * (280.0 / -mv.z) * pulse;
                gl_Position = projectionMatrix * mv;
            }
        `,
                fragmentShader: `
            varying vec3 vColor;
            void main() {
                if (length(gl_PointCoord - 0.5) > 0.45) discard;
                gl_FragColor = vec4(vColor, 0.85);
            }
        `,
                transparent: true,
                blending: THREE.AdditiveBlending,
                depthWrite: false
            });

            globeGroup.add(new THREE.Points(geo, mat));
        }

        // ============================================================================
        // NODES (Profile Pictures with Glitch Shader)
        // ============================================================================
        function createNodes() {
            nodesGroup = new THREE.Group();
            globeGroup.add(nodesGroup);

            const nodeCount = Math.min(playlist.length, 30);
            const nodeRadius = 11.5;

            const profileVert = `
        varying vec2 vUv;
        void main() {
            vUv = uv;
            gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
        }
    `;
            const profileFrag = `
        uniform sampler2D map;
        uniform float time;
        uniform float glitch;
        varying vec2 vUv;

        float rand(vec2 st) { return fract(sin(dot(st, vec2(12.9898,78.233))) * 43758.5453); }

        void main() {
            vec2 uv = vUv;
            if (glitch > 0.1) {
                float slice = floor(uv.y * 12.0);
                uv.x += (rand(vec2(slice, floor(time * 25.0))) - 0.5) * 0.12 * glitch;
            }
            float r = texture2D(map, uv + vec2(0.012 * glitch, 0.0)).r;
            float g = texture2D(map, uv).g;
            float b = texture2D(map, uv - vec2(0.012 * glitch, 0.0)).b;
            float scan = sin(uv.y * 80.0 + time * 8.0) * 0.08;
            vec3 col = vec3(r, g, b) - scan;
            float dist = distance(uv, vec2(0.5));
            if (dist > 0.5) discard;
            if (dist > 0.47) col = vec3(0.0, 1.0, 0.25);
            gl_FragColor = vec4(col, 1.0);
        }
    `;

            for (let i = 0; i < nodeCount; i++) {
                const phi = Math.acos(1 - 2 * (i + 0.5) / nodeCount);
                const theta = Math.PI * (1 + Math.sqrt(5)) * (i + 0.5);
                const x = nodeRadius * Math.cos(theta) * Math.sin(phi);
                const y = nodeRadius * Math.sin(theta) * Math.sin(phi);
                const z = nodeRadius * Math.cos(phi);

                const pivot = new THREE.Group();
                pivot.position.set(x, y, z);
                nodesGroup.add(pivot);

                const track = playlist[i];
                const imgUrl = track.img ? R2_PICS + encodeURIComponent(track.img) : null;
                const tex = imgUrl ? new THREE.TextureLoader().load(imgUrl) : null;

                const mat = new THREE.ShaderMaterial({
                    uniforms: {
                        map: { value: tex || new THREE.Texture() },
                        time: { value: 0 },
                        glitch: { value: 0 }
                    },
                    vertexShader: profileVert,
                    fragmentShader: profileFrag,
                    transparent: true,
                    side: THREE.DoubleSide
                });

                const mesh = new THREE.Mesh(new THREE.PlaneGeometry(1.4, 1.4), mat);
                mesh.userData = { idx: i, track };
                pivot.add(mesh);

                // Rings
                const rings = new THREE.Group();
                const r1 = new THREE.Mesh(new THREE.TorusGeometry(0.9, 0.015, 16, 40), new THREE.MeshBasicMaterial({ color: 0x00ffff, transparent: true, opacity: 0 }));
                r1.rotation.x = Math.PI / 2;
                rings.add(r1);
                const r2 = new THREE.Mesh(new THREE.TorusGeometry(1.1, 0.015, 16, 40), new THREE.MeshBasicMaterial({ color: 0xff9500, transparent: true, opacity: 0 }));
                r2.rotation.y = Math.PI / 2;
                rings.add(r2);
                pivot.add(rings);

                nodeMeshes.push({ pivot, mesh, mat, rings, worldPos: new THREE.Vector3(x, y, z) });

                // Label
                const label = document.createElement('div');
                label.className = 'node-label';
                label.textContent = track.title;
                document.body.appendChild(label);
                labelElements.push({ div: label, mesh });
            }
        }

        // ============================================================================
        // PARTICLE EXPLOSION SYSTEM
        // ============================================================================
        let explosionParticles = [];

        function createParticleSystem() {
            particleSystem = new THREE.Group();
            scene.add(particleSystem);
        }

        function spawnExplosion() {
            const count = 60;
            for (let i = 0; i < count; i++) {
                const geo = new THREE.BoxGeometry(0.15, 0.15, 0.15);
                const colors = [0x00ff41, 0x00ffff, 0xff9500, 0xff4444];
                const mat = new THREE.MeshBasicMaterial({ color: colors[Math.floor(Math.random() * 4)], transparent: true, opacity: 1 });
                const mesh = new THREE.Mesh(geo, mat);
                mesh.position.set(0, 0, 0);
                const vel = new THREE.Vector3((Math.random() - 0.5) * 2, (Math.random() - 0.5) * 2, (Math.random() - 0.5) * 2).normalize().multiplyScalar(0.4 + Math.random() * 0.3);
                particleSystem.add(mesh);
                explosionParticles.push({ mesh, vel, life: 1 });
            }
        }

        function updateParticles(delta) {
            explosionParticles = explosionParticles.filter(p => {
                p.mesh.position.add(p.vel);
                p.life -= delta * 1.2;
                p.mesh.material.opacity = p.life;
                if (p.life <= 0) {
                    particleSystem.remove(p.mesh);
                    return false;
                }
                return true;
            });
        }

        // ============================================================================
        // ANIMATION LOOP
        // ============================================================================
        let lastBeat = 0;

        function animate() {
            requestAnimationFrame(animate);
            const time = clock.getElapsedTime();
            const delta = clock.getDelta();

            // Audio
            const levels = getAudioLevels();
            bassUniform.value = levels.bass;
            highUniform.value = levels.high;
            audioUniform.value = levels.avg;

            // Beat detection
            if (levels.bass > 0.65 && time - lastBeat > 0.25) {
                lastBeat = time;
                spawnExplosion();
            }

            // Globe breathing
            globeGroup.scale.setScalar(1 + levels.bass * 0.08);
            globeGroup.rotation.y += 0.0012;

            // Update particles
            updateParticles(delta);

            // Update nodes
            const raycaster = new THREE.Raycaster();
            const mouse = new THREE.Vector2();

            nodeMeshes.forEach((n, i) => {
                n.mesh.lookAt(camera.position);
                n.mat.uniforms.time.value = time;
                n.mat.uniforms.glitch.value = levels.high * 0.8;

                // Rings pulse
                n.rings.rotation.x += 0.008;
                n.rings.rotation.y += 0.012;
                n.rings.children.forEach(r => r.material.opacity = levels.mid * 0.6);

                // Highlight active track
                if (i === currentIdx) {
                    n.mesh.scale.setScalar(THREE.MathUtils.lerp(n.mesh.scale.x, 1.8, 0.1));
                    n.mat.uniforms.glitch.value = 0.4 + levels.high;
                } else {
                    n.mesh.scale.setScalar(THREE.MathUtils.lerp(n.mesh.scale.x, 1, 0.1));
                }

                // Update label
                n.mesh.getWorldPosition(n.worldPos);
                n.worldPos.project(camera);
                const x = (n.worldPos.x * 0.5 + 0.5) * window.innerWidth;
                const y = (n.worldPos.y * -0.5 + 0.5) * window.innerHeight;
                const label = labelElements[i];
                label.div.style.transform = `translate(-50%, -50%) translate(${x}px,${y - 28}px)`;
                label.div.classList.toggle('visible', i === currentIdx);
            });

            controls.update();
            composer.render();
            updateProgress();
        }

        // ============================================================================
        // PLAYBACK CONTROLS
        // ============================================================================
        function loadTrack(idx) {
            if (idx < 0 || idx >= playlist.length) return;
            currentIdx = idx;
            const track = playlist[idx];

            if (ytPlayer && ytReady) ytPlayer.stopVideo();
            audioEl.pause();
            audioEl.currentTime = 0;

            document.getElementById('current-title').textContent = `${track.artist} - ${track.title}`;
            renderPlaylist();

            if (track.type === 'youtube' && ytPlayer && ytReady) {
                const seg = SONG_SEGMENTS[track.videoId];
                if (seg) {
                    ytPlayer.loadVideoById({ videoId: track.videoId, startSeconds: seg.start, endSeconds: seg.end });
                } else {
                    ytPlayer.loadVideoById(track.videoId);
                }
                ytPlayer.pauseVideo();
            } else if (track.type === 'audio') {
                audioEl.src = track.url;
                audioEl.load();
            }
        }

        window.togglePlay = function () {
            const track = playlist[currentIdx];
            if (audioCtx?.state === 'suspended') audioCtx.resume();

            if (track.type === 'youtube' && ytPlayer && ytReady) {
                isPlaying ? ytPlayer.pauseVideo() : ytPlayer.playVideo();
            } else {
                isPlaying ? audioEl.pause() : audioEl.play().catch(console.error);
            }
            isPlaying = !isPlaying;
            updatePlayBtn();
        };

        window.prevTrack = function () {
            let idx = currentIdx - 1;
            if (idx < 0) idx = playlist.length - 1;
            loadTrack(idx);
            if (isPlaying) setTimeout(window.togglePlay, 300);
        };

        window.nextTrack = function () {
            let idx = shuffleOn ? Math.floor(Math.random() * playlist.length) : (currentIdx + 1) % playlist.length;
            loadTrack(idx);
            if (isPlaying) setTimeout(window.togglePlay, 300);
        };

        window.toggleShuffle = function () {
            shuffleOn = !shuffleOn;
            document.getElementById('shuffle-btn').classList.toggle('active', shuffleOn);
        };

        window.setVolume = function (v) {
            audioEl.volume = v / 100;
            if (ytPlayer && ytReady) ytPlayer.setVolume(v);
        };

        window.seekTo = function (e) {
            const pct = e.offsetX / e.currentTarget.offsetWidth;
            const track = playlist[currentIdx];
            if (track.type === 'youtube' && ytPlayer && ytReady) {
                ytPlayer.seekTo(ytPlayer.getDuration() * pct, true);
            } else {
                audioEl.currentTime = audioEl.duration * pct;
            }
        };

        function updatePlayBtn() {
            document.getElementById('play-btn').textContent = isPlaying ? '‚è∏' : '‚ñ∂';
        }

        function updateProgress() {
            const track = playlist[currentIdx];
            let cur = 0, dur = 0;
            if (track.type === 'youtube' && ytPlayer && ytReady) {
                cur = ytPlayer.getCurrentTime() || 0;
                dur = ytPlayer.getDuration() || 0;
            } else {
                cur = audioEl.currentTime || 0;
                dur = audioEl.duration || 0;
            }
            if (dur > 0) {
                document.getElementById('progress-fill').style.width = `${(cur / dur) * 100}%`;
                document.getElementById('time-cur').textContent = formatTime(cur);
                document.getElementById('time-dur').textContent = formatTime(dur);
            }
        }

        function formatTime(s) {
            return `${Math.floor(s / 60)}:${String(Math.floor(s % 60)).padStart(2, '0')}`;
        }

        // ============================================================================
        // PLAYLIST UI
        // ============================================================================
        window.togglePlaylist = function () {
            document.getElementById('playlist-panel').classList.toggle('open');
        };

        window.setFilter = function (f) {
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.toggle('active', b.dataset.filter === f));
            playlist = f === 'all' ? [...MASTER_PLAYLIST] : MASTER_PLAYLIST.filter(t => t.category === f);
            currentIdx = 0;
            renderPlaylist();
            loadTrack(0);
        };

        function renderPlaylist() {
            document.getElementById('playlist-tracks').innerHTML = playlist.map((t, i) => `
        <div class="track-item ${i === currentIdx ? 'active' : ''}" onclick="selectTrack(${i})">
            <span class="track-idx">${String(i + 1).padStart(2, '0')}</span>
            <span class="track-name">${t.artist} - ${t.title}</span>
            <span class="track-type ${t.type}">${t.type === 'youtube' ? 'YT' : 'WAV'}</span>
        </div>
    `).join('');
        }

        window.selectTrack = function (i) {
            loadTrack(i);
            window.togglePlay();
        };

        // Audio Events
        audioEl.addEventListener('ended', window.nextTrack);
        audioEl.addEventListener('play', () => { isPlaying = true; updatePlayBtn(); });
        audioEl.addEventListener('pause', () => { isPlaying = false; updatePlayBtn(); });
    </script>
</body>

</html>